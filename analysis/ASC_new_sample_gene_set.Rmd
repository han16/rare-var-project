---
title: "ASC new sample gene set analysis"
output: html_doc ment
---


```{r, echo=F, warning=F, message=F}
rm(list=ls())
set.seed(123)
library(knitr)
library(RSQLite)
library(dplyr)
library(knitr)
library(kableExtra)
library(RColorBrewer)
library(gplots)
library(tidyverse)
library(gridExtra)
library(ggpubr)
#library("devtools")
#install.packages("Rtools")
#install_github('xinhe-lab/mirage')
library(mirage)
```


```{r, echo=F, cache=T, warning=F, message=F}
### read into new sample 
path="C:\\Shengtong\\research\\rare-var\\"
ASC_new_sample3=as_tibble(read.table(paste(path, "ASC\\ASC_v17_raw_TDT_by_parent_2021-05-10.txt", sep=""), sep='\t',  header=T, fill=T)) # this is the correct way that Kyle read the data
ASC_new_sample3=ASC_new_sample3 %>% filter(isSyn=="FALSE") # filter syn variants first 
```


```{r burdern analysis-gene level, results='hide', echo=F, warning=F, message=F}
# read into gene set 
path="C:\\Shengtong\\Research\\rare-var\\"
GeneDB=src_sqlite(path=paste(path, "gene.list.db", sep=""), create=F)
#GeneDB=src_sqlite(path="../../gene.list.db", create=F)
gene_cate1=data.frame(collect(tbl(GeneDB, "SFARI_HighConf")))
gene_cate2=data.frame(collect(tbl(GeneDB, "SFARI_StrongCand")))
gene_cate3=data.frame(collect(tbl(GeneDB, "SFARI_cate3_gene")))
gene_cate4=data.frame(collect(tbl(GeneDB, "SFARI_cate4_gene")))
gene_cate5=data.frame(collect(tbl(GeneDB, "SFARI_cate5_gene")))
gene_cate6=data.frame(collect(tbl(GeneDB, "SFARI_cate6_gene")))
gene_cateS=data.frame(collect(tbl(GeneDB, "SFARI_cateS_gene")))
TADAGene=data.frame(collect(tbl(GeneDB, "TADAGenelist")))
Qlessthan5percentgene=TADAGene$TadaName[TADAGene$qvalue.combined<0.05]
Qlessthan20percentgene=TADAGene$TadaName[TADAGene$qvalue.combined<0.2]
Qlessthan30percentgene=TADAGene$TadaName[TADAGene$qvalue.combined<0.3]
Qlessthan40percentgene=TADAGene$TadaName[TADAGene$qvalue.combined<0.4]
Qlessthan50percentgene=TADAGene$TadaName[TADAGene$qvalue.combined<0.5]
Qlargerthan90percentgene=TADAGene$TadaName[TADAGene$qvalue.combined>0.9]
###### ID gene ######
ID_Gene=as.character(data.frame(collect(tbl(GeneDB, "Pinto14AJHG_IDgene")))$GeneID)
#### high confidence gene 
High_Confidence_Gene=union(union(gene_cate1$GeneID, gene_cate2$GeneID),Qlessthan5percentgene)
#### moderate confidence gene 
Moderate_Confidence_Gene=setdiff(union(union(gene_cate3$GeneID, gene_cateS$GeneID), Qlessthan30percentgene),Qlessthan5percentgene)
#### psd gene 
purcell.genelist=data.frame(collect(tbl(GeneDB, "Purcell2014_genelist"))) ## PSD gene, SCZdenovo gene 
PSD_Gene=purcell.genelist$Gene_symbol[purcell.genelist$PSD=="Y"]
#### FMRP gene 
FMRP_Gene=purcell.genelist$Gene_symbol[purcell.genelist$FMRP.target=="Y"]
#### Autism KB gene 
ASD_KB_Gene=as.character(data.frame(collect(tbl(GeneDB, "AutismKB_gene")))$GeneID)
#### constraint gene 
Constraint_Gene=data.frame(collect(tbl(GeneDB, "Samocha_2014NG_constraintgene")))$gene
### RVIS gene 
RVIS.Allgene=data.frame(collect(tbl(GeneDB, "RVIS_gene")))
RVIS_Gene=RVIS.Allgene$GeneID[RVIS.Allgene$RVIS.percentile<5] # top 5% gene
#### Haplo insufficient gene 
Haploinsufficient_Gene=as.character(data.frame(collect(tbl(GeneDB, "Petrovski_plosgen_haploinsuff_gene")))$GeneID)
#### SCZ data 
SCZ_Gene=purcell.genelist$Gene_symbol
Gene_Set=c("ID gene","High", "Mod", "PSD", "FMRP", "AutismKB", "constraint gene", "RVIS", "Haploinsuff", "SCZ gene")
Gene_Set_List=list()
Gene_Set_List[[1]]=ID_Gene
Gene_Set_List[[2]]=High_Confidence_Gene
Gene_Set_List[[3]]=Moderate_Confidence_Gene
Gene_Set_List[[4]]=PSD_Gene
Gene_Set_List[[5]]=FMRP_Gene
Gene_Set_List[[6]]=ASD_KB_Gene
Gene_Set_List[[7]]=Constraint_Gene
Gene_Set_List[[8]]=RVIS_Gene
Gene_Set_List[[9]]=Haploinsufficient_Gene
Gene_Set_List[[10]]=SCZ_Gene
```



## Genome-wide analysis



```{r, echo=F, warning=F, message=F}

##### count transmitted variants and untransmitted in proband by summing over male, female, dad, mom and ind 
######### use ASC_new_sample3 rather than ASC_new_sample2
Transmitted_proband=ASC_new_sample3%>% select(starts_with("t_proband"))%>%  mutate(Transmitted_proband = select(., t_proband_male_dad:t_proband_female_ind) %>% rowSums())%>% select(Transmitted_proband) # extract transmitted variants for proband 

Untransmitted_proband=ASC_new_sample3%>% select(starts_with("u_proband"))%>%  mutate(Untransmitted_proband = select(., u_proband_male_dad:u_proband_female_ind) %>% rowSums())%>% select(Untransmitted_proband) # extract untransmitted variants for proband 

Transmitted_sibling=ASC_new_sample3%>% select(starts_with("t_sibling"))%>%  mutate(Transmitted_sibling = select(., t_sibling_male_dad:t_sibling_female_ind) %>% rowSums())%>% select(Transmitted_sibling) # extract transmitted variants for sibling 

Untransmitted_sibling=ASC_new_sample3%>% select(starts_with("u_sibling"))%>%  mutate(Untransmitted_sibling = select(., u_sibling_male_dad:u_sibling_female_ind) %>% rowSums())%>% select(Untransmitted_sibling) # extract untransmitted variants for sibling

##### add new columns of total transmitted and non-transmitted variants 
#ASC_new_sample=ASC_new_sample3%>%mutate(Transmitted_proband=Transmitted_proband$Transmitted_proband, Untransmitted_proband=Untransmitted_proband$Untransmitted_proband, Transmitted_sibling=Transmitted_sibling$Transmitted_sibling, Untransmitted_sibling=Untransmitted_sibling$Untransmitted_sibling) %>% filter(isIndel=="FALSE" & VQSLOD<9) # exclude indel & VQSLOD filter 

################################################


ASC_new_sample=ASC_new_sample3%>%mutate(Transmitted_proband=Transmitted_proband$Transmitted_proband, Untransmitted_proband=Untransmitted_proband$Untransmitted_proband, Transmitted_sibling=Transmitted_sibling$Transmitted_sibling, Untransmitted_sibling=Untransmitted_sibling$Untransmitted_sibling) %>% filter(isIndel=="FALSE" & QD >= 10 & AS_SOR <= 3 & AS_ReadPosRankSum >= -0.8) # exclude indel & apply other filters for SNP's 

##################
#AF_cutoff=0.001
#sum(ASC_new_sample %>% filter(pLI>=0.995 & isPTV==T & Gnomad_non_neuro_AF<AF_cutoff) %>% select(Transmitted_proband) %>% pull)   
#sum(ASC_new_sample %>% filter(pLI>=0.995 & isPTV==T & Gnomad_non_neuro_AF<AF_cutoff) %>% select(Untransmitted_proband) %>% pull)   
########### 1164 vs 1413 not 695 vs 557 in cell paper 


# add one column of variant group index 
ASC_new_sample_GI=ASC_new_sample %>% add_column(Group_Index=NA)

ASC_new_sample_GI$Group_Index[which(ASC_new_sample_GI$pLI>=0.995 & ASC_new_sample_GI$isPTV==T)]=1
ASC_new_sample_GI$Group_Index[which(ASC_new_sample_GI$pLI>=0.5 & ASC_new_sample_GI$pLI<0.995 & ASC_new_sample_GI$isPTV==T)]=2
ASC_new_sample_GI$Group_Index[which(ASC_new_sample_GI$pLI<0.5 & ASC_new_sample_GI$isPTV==T)]=3
ASC_new_sample_GI$Group_Index[which(ASC_new_sample_GI$MPC>=2)]=4
ASC_new_sample_GI$Group_Index[which(ASC_new_sample_GI$MPC>=1 & ASC_new_sample_GI$MPC<2)]=5
ASC_new_sample_GI$Group_Index[which(ASC_new_sample_GI$MPC<1)]=6

num.family=7291
## test 
```
### Variant count in PTV with `PLI>=0.995`


| AF cutoff      | Trans |   Untrans    | 
| :---        |    :----:   |          ---: |
| <0.000001    | 659    | 655   |
| <0.00001    | 779    | 805   |      
| <0.0001    | 876    | 966   |
| <0.001    | 1164    | 1413   |


When AF <0.1%, there are 1164 transmitted variants and 1413 untransmitted, not consistent with numbers in cell paper 695 vs 557.  

* `pLI>=0.995`
* `isPTV==T`
* `isIndel=="FALSE"`
* `Gnomad_non_neuro_AF<AF_cutoff`
* `num_alleles<5`



| filter      | Trans |   Untrans    | 
| :---        |    :----:   |          ---: |
|  VQSLOD<3.75   | 255    | 546   |
| VQSLOD<5.13    | 300    | 624   |
| VQSLOD<9    | 1151    | 1415  |
| QD >= 1 & AS_SOR <= 3 & AS_ReadPosRankSum >= -0.8    | 818    | 785   |
| QD >= 6 & AS_SOR <= 3 & AS_ReadPosRankSum >= -0.8    | 816    | 726   |
| QD >= 10 & AS_SOR <= 3 & AS_ReadPosRankSum >= -0.8    | 738    | 604   |
| QD >= 10.5 & AS_SOR <= 3 & AS_ReadPosRankSum >= -0.8    | 714    | 567   |
| QD >= 11 & AS_SOR <= 3 & AS_ReadPosRankSum >= -0.8    | 678    | 526   |
| QD >= 1 & AS_SOR <= 3 & AS_ReadPosRankSum >= -2   | 956    | 946   |
| QD >= 1 & AS_SOR <= 5 & AS_ReadPosRankSum >= -0.8   | 821    | 804   |
| QD >= 1 & AS_SOR <= 10 & AS_ReadPosRankSum >= -0.8   | 822    | 861   |

* Kyle suggested: QD >= 1 & AS_SOR <= 3 & AS_ReadPosRankSum >= -0.8 
* with filter `QD >= 6 & AS_SOR <= 3 & AS_ReadPosRankSum >= -0.8  `, 0.11 transmitted  (816/7291) vs 0.10 untransmitted  vps
* cutoff for `AS_ReadPosRankSum` could decrease to, for instance -2, or even lower, while maintaining balanced T/UT, but the OR consistently stay around 1.01, a bit away from 1.2 
* OR will increase with increasing cutoff for `QD`. When cutoff =10.5, both OR and variant counts are close to numbers in paper, but when cutoff >10.5, the variant count will become smaller than than in paper, seems not appropriate.  
* With balanced T/UT, increase of cutoff for `AS_SOR` will decrease OR, even below 1, becoming depleted  
* `pLI>=0.995`
* `isPTV==T`
* `isIndel=="FALSE"`
* `Gnomad_non_neuro_AF<0.001`


### plot of QD value 

```{r, echo=F, message=F, warning=F}
############## plot of QD values 
QD=ASC_new_sample3%>%mutate(Transmitted_proband=Transmitted_proband$Transmitted_proband, Untransmitted_proband=Untransmitted_proband$Untransmitted_proband, Transmitted_sibling=Transmitted_sibling$Transmitted_sibling, Untransmitted_sibling=Untransmitted_sibling$Untransmitted_sibling) %>% filter(isIndel=="FALSE"  & AS_SOR <= 3 & AS_ReadPosRankSum >= -0.8) %>% select(QD) %>% pull
plot(density(QD))
summary(QD)
```


use filters 

* `isIndel=="FALSE"`
* `AS_SOR <= 3`
* `AS_ReadPosRankSum >= -0.8`



### Run mirage-vs on 6 variant groups in Kyle data  without gene level information 



* Use mirage-vs to test if there are signals in six variant groups  
* filter `Gnomad_non_neuro_AF<0.05` was applied 
* `isIndel=="FALSE" & QD >= 10 & AS_SOR <= 3 & AS_ReadPosRankSum >= -0.8`

```{r, echo=F, eval=F}
####### test the toy example 
#data(mirage_vs_toy)
#res_vs = mirage_vs(mirage_vs_toy,n1=1000,n2=1000)
#########
para_est=matrix(nrow=6, ncol=6)
rownames(para_est)=c("PLI>=0.995", "pLI within (0.5,0.995)", "pLI<0.5", "MPC>=2", "MPC within (1,2)", "MPC<1")
colnames(para_est)=c("No_case", "No_contr", "OR", "pval", "eta_est", "eta_pval")
for (i in 1:6)
{ 
#i=1  
 cat(i, "is running", "\n")
 variant_set=ASC_new_sample_GI %>% filter(Group_Index==i & Gnomad_non_neuro_AF<0.05) %>% select(Variant, Transmitted_proband, Untransmitted_proband, Group_Index) %>% drop_na()
 para_est[i,1:2]=c(sum(variant_set$Transmitted_proband),sum(variant_set$Untransmitted_proband))
 pois.test=poisson.test(para_est[i,1:2], c(num.family, num.family), r=1, alternative="greater")
 para_est[i,3:4]=c(pois.test$estimate,pois.test$p.value)
 if (i<=3) # for LoF variants
   vs.mirage=mirage_vs(variant_set[,2:4],n1=num.family,n2=num.family, gamma=6)
 if (i>3)  # for missense variants 
   vs.mirage=mirage_vs(variant_set[,2:4],n1=num.family,n2=num.family, gamma=3)
 para_est[i,5:6]=c(vs.mirage$eta.est, vs.mirage$eta.pvalue)
  
}
as_tibble(para_est)
#write.csv(para_est, file="../output/KyleData/para.est.var.group.proband.csv")
#gene.data=eight.partition(cand.data)
#ds.asd.result=mirage(gene.data, n1=2403, n2=2403)
```


This figure shows the comparison between burden test (one side two sample poisson test) and mirage-vs for proband in 6 variant groups. $\gamma=6$ for 3 PLI variant groups  and $\gamma=3$ for another 3 MPC groups when running mirage.  

```{r, echo=F, warning=F, message=F}
proband_para_est=read.csv("../output/KyleData/para.est.var.group.proband.csv")
as_tibble(proband_para_est)


var_group=c(rep(c("(1):PLI>=0.995", "(2):pLI>=0.5&pLI<0.995", "(3):pLI<0.5", "(4):MPC>=2", "(5):MPC>=1&MPC<2", "(6):MPC<1"), 2))
method=c(rep("Burden", 6), rep("mirage-vs", 6))
pvalue=c(round(-log(proband_para_est$pval, base=10), 2), round(-log(proband_para_est$eta_pval, base=10), 2))
summary=data.frame(var.group=var_group, pvalue=pvalue, method=method)
ggplot(summary, aes(x=var.group, y=pvalue, fill=method)) + 
   geom_bar(stat="identity", 
           position=position_dodge())+
  ylab(expression(-log[10](pvalue)))+
  theme(legend.title=element_blank())+
  xlab("variant groups")+
  ggtitle("")+
  theme(plot.title = element_text(hjust = 0.5, size=10))+  #center the title 
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=10))
  #ylab(expression(paste(hat(eta))))+ 
  #guides(fill=guide_legend(title=NULL))+
  #ylim(0.05,0.15)+
  # geom_hline(yintercept=0.1,linetype="dashed", color = "red")
```

### Run MIRAGE-VS on 180 variant sets 


```{r, echo=F, eval=F}
####### test the toy example 
#data(mirage_vs_toy)
#res_vs = mirage_vs(mirage_vs_toy,n1=1000,n2=1000)
#########
para_est=matrix(nrow=180, ncol=7)
rownames(para_est)=paste(rep(paste(rep(Gene_Set,each=6), c("PLI>=0.995", "pLI within (0.5,0.995)", "pLI<0.5", "MPC>=2", "MPC within (1,2)", "MPC<1"), sep="_"), each=3), c("0.001<AF<0.01", "0.0001<0.001", "AF<0.0001"), sep="_")
colnames(para_est)=c("No_case", "No_contr", "OR", "pval", "eta_est", "eta_pval", "cate_index")
for (i in 1:1) # for each gene set
  for (j in 1:6) # for each variant group
{ 
#i=1  
 cat(i, "is running", "\n")
    k=((i-1)*6+j-1)*3
    ###################
 variant_set=ASC_new_sample_GI %>% filter( Gene %in% Gene_Set_List[[i]]==T &  Group_Index==j & Gnomad_non_neuro_AF>0.001 & Gnomad_non_neuro_AF<0.01 & isSyn=="FALSE") %>% select(Variant, Transmitted_proband, Untransmitted_proband, Group_Index) %>% drop_na()
 if (nrow(variant_set)>0)
 {
 para_est[k+1,1:2]=c(sum(variant_set$Transmitted_proband),sum(variant_set$Untransmitted_proband))
 pois.test=poisson.test(para_est[k+1,1:2], c(num.family, num.family), r=1, alternative="greater")
 para_est[k+1,3:4]=c(pois.test$estimate,pois.test$p.value)
 if (j<=3) # for LoF variants
   vs.mirage=mirage_vs(variant_set[,2:4],n1=num.family,n2=num.family, gamma=6)
 if (j>3)  # for missense variants 
   vs.mirage=mirage_vs(variant_set[,2:4],n1=num.family,n2=num.family, gamma=3)
 para_est[k+1,5:6]=c(vs.mirage$eta.est, vs.mirage$eta.pvalue)
 }
 para_est[k+1,7]=j  # group index need to be recorded regardless of having variants or not 
 ###################
 variant_set=ASC_new_sample_GI %>% filter( Gene %in% Gene_Set_List[[i]]==T &  Group_Index==j & Gnomad_non_neuro_AF>0.0001 & Gnomad_non_neuro_AF<0.001 & isSyn=="FALSE") %>% select(Variant, Transmitted_proband, Untransmitted_proband, Group_Index) %>% drop_na()
 if (nrow(variant_set)>0)
 {
 para_est[k+2,1:2]=c(sum(variant_set$Transmitted_proband),sum(variant_set$Untransmitted_proband))
 pois.test=poisson.test(para_est[k+2,1:2], c(num.family, num.family), r=1, alternative="greater")
 para_est[k+2,3:4]=c(pois.test$estimate,pois.test$p.value)
 if (j<=3) # for LoF variants
   vs.mirage=mirage_vs(variant_set[,2:4],n1=num.family,n2=num.family, gamma=6)
 if (j>3)  # for missense variants 
   vs.mirage=mirage_vs(variant_set[,2:4],n1=num.family,n2=num.family, gamma=3)
 para_est[k+2,5:6]=c(vs.mirage$eta.est, vs.mirage$eta.pvalue)
 }  
 para_est[k+2,7]=j  # group index need to be recorded regardless of having variants or not
 ###################
 variant_set=ASC_new_sample_GI %>% filter( Gene %in% Gene_Set_List[[i]]==T &  Group_Index==j &  Gnomad_non_neuro_AF<0.0001 & isSyn=="FALSE") %>% select(Variant, Transmitted_proband, Untransmitted_proband, Group_Index) %>% drop_na()
 if (nrow(variant_set)>0)
 {
 para_est[k+3,1:2]=c(sum(variant_set$Transmitted_proband),sum(variant_set$Untransmitted_proband))
 pois.test=poisson.test(para_est[k+3,1:2], c(num.family, num.family), r=1, alternative="greater")
 para_est[k+3,3:4]=c(pois.test$estimate,pois.test$p.value)
 if (j<=3) # for LoF variants
   vs.mirage=mirage_vs(variant_set[,2:4],n1=num.family,n2=num.family, gamma=6)
 if (j>3)  # for missense variants 
   vs.mirage=mirage_vs(variant_set[,2:4],n1=num.family,n2=num.family, gamma=3)
 para_est[k+3,5:6]=c(vs.mirage$eta.est, vs.mirage$eta.pvalue)
 }
 para_est[k+3,7]=j  # group index need to be recorded regardless of having variants or not
} # end of  for (j in 1:6) # for each variant group
#as_tibble(para_est)
#write.csv(para_est, file="../output/KyleData/MIRAGE_VS.for.180.variant.group.proband_0824_2022.csv")
```


```{r, echo=F, message=F, warning=F}

para_est=read.csv("../output/KyleData/MIRAGE_VS.for.180.variant.group.proband_0824_2022.csv", header=T)
############### plot the results 
#para_est_withoutNA=as_tibble(para_est) %>% drop_na()
para_est_withoutNA=para_est[complete.cases(para_est), ]
############### multiple correction for p values
Burden.pvalue=para_est_withoutNA[,5]
MIRAGE.pvalue=para_est_withoutNA[,7]
Burden.MIRAGE.pvalue=cbind(Burden.pvalue, MIRAGE.pvalue)
Burden.pvalue.adjust=p.adjust(Burden.pvalue, method="BH", n=length(Burden.pvalue))
MIRAGE.pvalue.adjust=p.adjust(MIRAGE.pvalue, method="BH", n=length(MIRAGE.pvalue))

Burden.MIRAGE.pvalue.adjust.pvalue=tibble(Burden.pvalue=Burden.pvalue, MIRAGE.pvalue=MIRAGE.pvalue, Burden.adjust.pvalue=Burden.pvalue.adjust, MIRAGE.adjust.pvalue=MIRAGE.pvalue.adjust)
burden.pvalue.fdr.0.05.cutoff=Burden.MIRAGE.pvalue.adjust.pvalue%>% filter(Burden.adjust.pvalue<0.05) %>% summarize(max.burden.pvalue=max(Burden.pvalue)) %>% pull()
mirage.pvalue.fdr.0.05.cutoff=Burden.MIRAGE.pvalue.adjust.pvalue%>% filter(MIRAGE.adjust.pvalue<0.05) %>% summarize(max.mirage.pvalue=max(MIRAGE.pvalue)) %>% pull()
 
##############

Burden.MIRAGE.combine=tibble(Burden.OR=para_est_withoutNA[,4], Burden.pvalue=Burden.pvalue, MIRAGE.risk.prop=para_est_withoutNA[,6], MIRAGE.pvalue=MIRAGE.pvalue, No.var.case=para_est_withoutNA[,2], No.var.control=para_est_withoutNA[,3], combine.feature=para_est_withoutNA[,1], cate.index=para_est_withoutNA[,8])
Burden.MIRAGE.combine <- drop_na(Burden.MIRAGE.combine) # remove rows with NA
#Burden.MIRAGE.combine.clear <- as_tibble(data.matrix(Burden.MIRAGE.combine)[is.finite(rowSums(data.matrix(Burden.MIRAGE.combine))),])
Burden.MIRAGE.combine.clear=Burden.MIRAGE.combine
Burden.MIRAGE.combine.clear$cate.index=Burden.MIRAGE.combine.clear$cate.index %>% recode("1"="PTV:pLI>=0.995", "2"="PTV:0.5<pLI<0.995", "3"="PTV: pLI<0.5", "4"="MPC>=2", "5"="1<=MPC<2", "6"="0<MPC<1")



################### save significant combined features with p values less than 0.05
significant.combined.features=Burden.MIRAGE.combine.clear %>% filter(Burden.pvalue<0.05 | MIRAGE.pvalue<0.05) %>% arrange(MIRAGE.pvalue)
#write.csv(Burden.MIRAGE.combine.clear, file="../output/CombinedFeature/combined.features.of.gene.set.disjoint.AF.damaging.csv")
###################
y.max=max(-log(Burden.pvalue, base=10), -log(MIRAGE.pvalue, base=10))
num.test=length(MIRAGE.pvalue)
g1=ggplot(as_tibble(Burden.MIRAGE.combine.clear), aes(x=Burden.OR, y=-log(Burden.pvalue, base=10), color=as.factor(cate.index), shape=as.factor(cate.index), size=1, stroke = 0.5))+
  scale_shape_manual(values=1:nlevels(as.factor(Burden.MIRAGE.combine.clear$cate.index)))+
  geom_point()+
  #xlim(c(0,4))+
  ylim(c(0,y.max+2))+
  geom_hline(yintercept=-log(0.05/num.test, base=10), linetype="dashed", color = "red")+
  geom_hline(yintercept=-log(burden.pvalue.fdr.0.05.cutoff, base=10), linetype="solid", color = "blue")+
  xlab("OR")+ylab(expression(paste("-log" [10], "(p value)")))+
  ggtitle("Burden")+
  theme_classic()+
   theme(legend.position = "none")+  # no legend 
#theme(plot.title = element_text(hjust = 0.5, size=35)) +# center the title 
  theme(plot.title = element_text(hjust = 0.5)) +# center the title 
theme(legend.title=element_blank())+
theme(legend.text=element_text(size=20))+
theme(text = element_text(size=20))+
guides(size=FALSE)+  # suppress size legend 
guides(shape = guide_legend(override.aes = list(size = 5))) # symbol size in legend 

g2=ggplot(as_tibble(Burden.MIRAGE.combine.clear), aes(x=MIRAGE.risk.prop, y=-log(MIRAGE.pvalue, base=10), color=as.factor(cate.index), shape=as.factor(cate.index),size=5))+
  scale_shape_manual(values=1:nlevels(as.factor(Burden.MIRAGE.combine.clear$cate.index)))+  # manually define shapes if more than 6 groups 
  geom_point()+
  xlab(expression(paste(hat(eta))))+
  ylab("")+
  ylim(c(0,y.max+2))+
  geom_hline(yintercept=-log(0.05/num.test, base=10), linetype="dashed", color = "red")+
  geom_hline(yintercept=-log(mirage.pvalue.fdr.0.05.cutoff, base=10), linetype="solid", color = "blue")+
  ggtitle("MIRAGE-VS")+
  theme_classic()+
  #theme(plot.title = element_text(hjust = 0.5, size=35))+  # center the title 
  theme(plot.title = element_text(hjust = 0.5))+  # center the title 
  #labs(color='variant group')+   # define legend title 
  theme(legend.title=element_blank())+
theme(text = element_text(size=20))


  #theme(legend.text=element_text(size=10))
  #theme(legend.position = c(0.8, 4),
  #        legend.direction = "vertical")
#+
  #theme(legend.position="bottom")
#pdf("C:/Users/han24/OneDrive - UWM/rare-var/Figure/Supp/Fig-Burden_MIRAGE-vs_CombinedFeature_Split.pdf")
ggarrange(g1, g2,nrow=1, common.legend = TRUE, legend="bottom") 
#dev.off()
```

* exclude syn variants `isSyn=="FALSE"`

* 6 variant groups X 3 AF categories (0.001<AF<0.01, 0.0001<AF<0.001, AF<0.0001) X 10 gene sets=180 variant groups 

* use filter `isIndel=="FALSE" & QD >= 10 & AS_SOR <= 3 & AS_ReadPosRankSum >= -0.8`

* solid blue line is FDR 0.05 and dashed red line is Bonferroni correction p = 0.05/total number of tests.



```{r, echo=F, message=F, warning=F}
ggplot(data.frame(Burden_pval=-log(Burden.MIRAGE.combine.clear$Burden.pvalue, base=10), MIRAGE_VS_pval=-log(Burden.MIRAGE.combine.clear$MIRAGE.pvalue, base=10), OR=Burden.MIRAGE.combine.clear$Burden.OR), aes(x=Burden_pval, y=MIRAGE_VS_pval))+geom_point(aes(size=OR))+
  geom_abline(intercept =0, slope = 1, color="red")+
  xlab(expression(paste("Burden: -log" [10], "(p value)")))+
  ylab(expression(paste("MIRAGE_VS: -log" [10], "(p value)")))+
   ggtitle("MIRAGE-VS vs Burden for 180 variant groups")+
  theme_classic()+
  theme(plot.title = element_text(hjust = 0.5, size=20))  # center the title
  
```

```{r, echo=F, warning=F, message=F}
gamma_pvalue=data.frame(gamma=seq(1,10),pvalue=c(0.2595, 0.0896, 0.0900, 0.1151, 0.1748, 0.2980, 0.5398, 0.9934, 1,1))
ggplot(data=gamma_pvalue, aes(x=gamma, y=pvalue, group=1)) +
  geom_line(color="red")+
  geom_point()+
  ggtitle("Relative risk vs  MIRAGE_vs pvalues")+
  ylim(c(0,1))+
  ylab("MIRAGE_VS: p value")+
  xlab("Relative risk: gamma")+
  geom_hline(yintercept=0.092, linetype="dashed", 
                color = "blue", size=1)+
  theme_classic()+
  theme(plot.title = element_text(hjust = 0.5, size=20))  # center the title

```

* variant set `ID gene_PLI>=0.995_0.001<AF<0.01`, two loci, 13 (Trans) vs 15 (Nontrans) and 21 vs 8=> 34 vs 23 in total. 

* varying $\bar{\gamma}$ produces quite different p values for MIRAGE_VS. 

* blue dashed line: burden test p value of 0.09242524



### gene set analysis taking into account gene level information

* Run mirage on all 17850 genes and $\gamma=6$ for 3  PLI variant groups   and $\gamma=3$ for 3  MPC groups. 

* apply filter `Gnomad_non_neuro_AF<0.05` 

* `isIndel=="FALSE" & QD >= 10 & AS_SOR <= 3 & AS_ReadPosRankSum >= -0.8`

```{r, echo=F, eval=F}
##!!!!!!!!!!!!!!!!! Do not run !!!!!!!!!!!!!!!!!!!
############  gene set 
num.family=7291
gene_set=ASC_new_sample_GI %>% filter(Gnomad_non_neuro_AF<0.05) %>% select(Variant, Gene, Transmitted_proband, Untransmitted_proband, Group_Index) %>% drop_na()
mirage_result=mirage(data.frame(gene_set),n1=num.family, n2=num.family, gamma=c(6,6,6,3,3,3)) # input data must be dataframe 
######### It takes more than one hour to finish running mirage function 

#res=mirage(mirage_toy,n1=4315,n2=4315) # test mirage function 
#write.csv(mirage_result$BF.PP.gene, file="../output/KyleData/BF.proband.AllGene.csv")
```

variant category |parameter | estimate |  p value |
-----------------|-----|-----|------|--------
\ |$\hat{\delta}$ | 0.0683 | 1.361528e-42
(1):PLI>=0.995|$\hat{\eta}_1$ | 0.8310    | $1.856047e-02$
(2):0.5<=pLI<0.995|$\hat{\eta}_2$ | 0.8482    | $1.222383e-02$
(3):pLI<0.5|$\hat{\eta}_3$ | 0.0290    | $6.837045e-01$
(4):MPC>=2|$\hat{\eta}_4$ | 0.4662    | $1.483169e-03$
(5):1<=MPC<2| $\hat{\eta}_5$ | 0.1124    | $1.451614e-12$
(6):0<=MPC<1| $\hat{\eta}_6$ | 0.0119    | $1.524884e-32$


```{r, echo=F}
var_group=c("(1):PLI>=0.995", "(2):pLI>=0.5&pLI<0.995", "(3):pLI<0.5", "(4):MPC>=2", "(5):MPC>=1&MPC<2", "(6):MPC<1")
estimate=c(0.8310, 0.8482, 0.0290, 0.4662, 0.1124, 0.0119)
summary=data.frame(var.group=var_group, estimate=estimate)
ggplot(summary, aes(x=var.group, y=estimate, fill=var.group)) + 
   geom_bar(stat="identity", position=position_dodge())+
  theme(legend.title=element_blank())+
  xlab("variant groups")+ylab(expression(paste(hat(eta))))+
  ggtitle("")+
  theme(plot.title = element_text(hjust = 0.5, size=10))+  #center the title 
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=10))
```


Below are top ranked genes. 
```{r, echo=F}
BF_proband_AllGene=as_tibble(read.csv("../output/kyleData/BF.proband.AllGene.csv"))
BF_proband_AllGene_sorted=BF_proband_AllGene%>%arrange(desc(post.prob))
#length(intersect(BF_proband_AllGene_sorted$Gene[1:100], ASD_102_Gene))
BF_proband_AllGene_sorted
#BF_proband_AllGene_sorted %>% filter(Gene %in% ASD_102_Gene) %>% print(n=102)
```




## 102 ASD genes in cell paper

```{r, echo=F}
ASD_Gene_Cell=as_tibble(read.csv("../../AutismDatafromASC_Cellpaper/1-s2.0-S0092867419313984-mmc2.csv", header = TRUE))
ASD_102_Gene=ASD_Gene_Cell[1:102,1] %>% pull()
```

```{r, echo=F, eval=F}
#########
para_est=matrix(nrow=6, ncol=6)
rownames(para_est)=c("PLI>=0.995", "pLI>=0.5&pLI<0.995", "pLI<0.5", "MPC>=2", "MPC>=1&MPC<2", "MPC<1")
colnames(para_est)=c("No_case", "No_contr", "OR", "pval", "eta_est", "eta_pval")
for (i in 1:6)
{ 
#i=2  
#cat(i, "is running", "\n")
############  variant set 
variant_set=ASC_new_sample_GI %>% filter(Gnomad_non_neuro_AF<0.05) %>% filter(Gene %in% ASD_102_Gene)%>% filter(Group_Index==i) %>% select(Variant, Transmitted_proband, Untransmitted_proband, Group_Index) %>% drop_na()
para_est[i,1:2]=c(sum(variant_set$Transmitted_proband),sum(variant_set$Untransmitted_proband))
pois.test=poisson.test(para_est[i,1:2], c(num.family, num.family), r=1, alternative="greater")
para_est[i,3:4]=c(pois.test$estimate,pois.test$p.value)
vs.mirage=mirage_vs(variant_set[,2:4],n1=num.family,n2=num.family, gamma=6)
para_est[i,5:6]=c(vs.mirage$eta.est, vs.mirage$eta.pvalue)
}
as_tibble(para_est)
#write.csv(para_est, file="../output/kyleData/para.est.var.group.proband.102ASDGene.csv")
#gene.data=eight.partition(cand.data)
#ds.asd.result=mirage(gene.data, n1=2403, n2=2403)
```

### variant set (VS) analysis without gene level information

This figure shows the comparison between burden test (one side two sample poisson test) and mirage-vs for proband in 6 variant groups. $\gamma=6$ for 3 PLI variant groups and $\gamma=3$ for 3 MPC groups when running mirage.

```{r, echo=F}
proband_para_est=read.csv("../output/kyleData/para.est.var.group.proband.102ASDGene.csv")
as_tibble(proband_para_est)


var_group=c(rep(c("(1):PLI>=0.995", "(2):pLI>=0.5&pLI<0.995", "(3):pLI<0.5", "(4):MPC>=2", "(5):MPC>=1&MPC<2", "(6):MPC<1"), 2))
method=c(rep("Burden", 6), rep("mirage-vs", 6))
pvalue=c(round(-log(proband_para_est$pval, base=10), 2), round(-log(proband_para_est$eta_pval, base=10), 2))
summary=data.frame(var.group=var_group, pvalue=pvalue, method=method)
ggplot(summary, aes(x=var.group, y=pvalue, fill=method)) + 
   geom_bar(stat="identity", 
           position=position_dodge())+
  ylab(expression(-log[10](pvalue)))+
  theme(legend.title=element_blank())+
  xlab(" variant groups")+
  ggtitle(" p value comparison between Burden and MIRAGE-VS")+
  theme(plot.title = element_text(hjust = 0.5, size=10))+  #center the title 
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=10))
  #ylab(expression(paste(hat(eta))))+ 
  #guides(fill=guide_legend(title=NULL))+
  #ylim(0.05,0.15)+
  # geom_hline(yintercept=0.1,linetype="dashed", color = "red")
```


### gene set analysis taking into account gene level information

* $\gamma=6$ for LoF variant and $\gamma=3$ for missense when running mirage.

* apply filter `Gnomad_non_neuro_AF<0.05` 


```{r,echo=F, eval=F}
############  gene set 
gene_set=ASC_new_sample_GI %>% filter(Gnomad_non_neuro_AF<0.05)%>% filter(Gene %in% ASD_102_Gene) %>% select(Variant, Gene, Transmitted_proband, Untransmitted_proband, Group_Index) %>% drop_na()
#mirage_result=mirage(data.frame(gene_set),n1=5869, n2=5869, gamma=c(6,6,6,3,3,3))
mirage_result=mirage(data.frame(gene_set),n1=num.family, n2=num.family)# input data must be dataframe
#res=mirage(mirage_toy,n1=4315,n2=4315) # test mirage function 
#write.csv(mirage_result$BF.PP.gene, file="../output/kyleData/BF.proband.102Gene.csv")
```

variant categories |parameter | estimate |  p value |
-------------------|-----|-----|------|--------
\ |$\hat{\delta}$ | 0.40 | $1.10\times 10^{-6}$
PLI>=0.995| $\hat{\eta}_1$ | 0.1452    | $1.13\times 10^{-6}$
0.5<=pLI<0.995 | $\hat{\eta}_2$ | 1  | 0.1546
pLI<0.5 | $\hat{\eta}_3$ | 0.7379    | 0.2145
MPC>=2 | $\hat{\eta}_4$ | 0.1789    | $5.20\times 10^{-4}$
1<=MPC<2 | $\hat{\eta}_5$ | $8.13\times 10^{-5}$    | 1
0<=MPC<1 | $\hat{\eta}_6$ | $6.64\times 10^{-12}$    | 1
Table: Parameter estimate by MIRAGE for 102 ASD genes. 



```{r, echo=F}
var_group=c("(1):PLI>=0.995", "(2):pLI>=0.5&pLI<0.995", "(3):pLI<0.5", "(4):MPC>=2", "(5):MPC>=1&MPC<2", "(6):MPC<1")
estimate=c(0.1452, 1, 0.7379, 0.1789, 0.0000813, 0)
summary=data.frame(var.group=var_group, estimate=estimate)
ggplot(summary, aes(x=var.group, y=estimate, fill=var.group)) + 
   geom_bar(stat="identity", position=position_dodge())+
  theme(legend.title=element_blank())+
  xlab("variant groups")+ylab(expression(paste(hat(eta))))+
  ggtitle("")+
  theme(plot.title = element_text(hjust = 0.5, size=10))+  #center the title 
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=10))
```



## Top 5% constraint genes 


### Burden analysis 

#### Look at all variants with AF<10E-4 

In old sample, we observe signal in constraint genes with $AF<10^{-4}$. 

```{r, echo=F, warning=F, message=F, cache=T}
Constraint_Gene=as.character(read.csv("../data/GeneSet/Samocha_2014NG_contraintgene.csv", header=T)$gene)
new_sample_trans_data_Constraint_Gene=ASC_new_sample_GI%>% filter(Gene %in% Constraint_Gene & Gnomad_non_neuro_AF<0.0001)%>% select(Variant, Gene, Transmitted_proband, Untransmitted_proband)%>%drop_na()
```

There are 199395 transmitted variants in proband and 204963 untransmitted variants. 

```{r, echo=T}
poisson.test(c(sum(new_sample_trans_data_Constraint_Gene$Transmitted_proband), sum(new_sample_trans_data_Constraint_Gene$Untransmitted_proband)), c(num.family, num.family), r=1, alternative="greater")
```

### Run MIRAGE-VS for all variants together

Put all variants with AF<10E-4 in one category and run MIRAGE-VS. $\widehat{\eta}=0.0041$, p value is $1.6\times 10^{-9}$.  

```{r, echo=F, eval=F}
Constraint_Gene_for_VS=new_sample_trans_data_Constraint_Gene%>% select(Transmitted_proband, Untransmitted_proband)%>%add_column(Group_Index=1)%>% drop_na()
########### here it takes about 5 mins to run mirage-VS 
vs.mirage=mirage_vs(data.frame(Constraint_Gene_for_VS),n1=num.family,n2=num.family)
```



### Run MIRAGE-VS on constraint genes with   6 variant groups in cell paper  without gene level information

```{r, echo=F, eval=F}
#########
Constraint_Gene=as.character(read.csv("../data/GeneSet/Samocha_2014NG_contraintgene.csv", header=T)$gene)
para_est=matrix(nrow=6, ncol=6)
rownames(para_est)=c("(1):PLI>=0.995", "(2):pLI>=0.5&pLI<0.995", "(3):pLI<0.5", "(4):MPC>=2", "(5):MPC>=1&MPC<2", "(6):MPC<1")
colnames(para_est)=c("No_case", "No_contr", "OR", "pval", "eta_est", "eta_pval")
for (i in 1:6)
{ 
#i=2  
#cat(i, "is running", "\n")
############  variant set 
variant_set=ASC_new_sample_GI %>% filter(Gnomad_non_neuro_AF<0.05) %>% filter(Gene %in% Constraint_Gene)%>% filter(Group_Index==i) %>% select(Variant, Transmitted_proband, Untransmitted_proband, Group_Index) %>% drop_na()
para_est[i,1:2]=c(sum(variant_set$Transmitted_proband),sum(variant_set$Untransmitted_proband))
pois.test=poisson.test(para_est[i,1:2], c(num.family, num.family), r=1, alternative="greater")
para_est[i,3:4]=c(pois.test$estimate,pois.test$p.value)
vs.mirage=mirage_vs(variant_set[,2:4],n1=num.family,n2=num.family, gamma=6)
para_est[i,5:6]=c(vs.mirage$eta.est, vs.mirage$eta.pvalue)
}
as_tibble(para_est)
#write.csv(para_est, file="../output/KyleData/para.est.var.group.proband.Constraint.Gene.csv")
#gene.data=eight.partition(cand.data)
#ds.asd.result=mirage(gene.data, n1=2403, n2=2403)
```


This figure shows the comparison between burden test (one side two sample poisson test) and mirage-vs for proband in 6 variant groups. 

* $\gamma=6$ for 3 PLI variant groups and $\gamma=3$ for 3 MPC groups when running mirage.

* apply filter `Gnomad_non_neuro_AF<0.05` 

```{r, echo=F}
proband_para_est=read.csv("../output/KyleData/para.est.var.group.proband.Constraint.Gene.csv")
as_tibble(proband_para_est)


var_group=c(rep(c("(1):PLI>=0.995", "(2):pLI>=0.5&pLI<0.995", "(3):pLI<0.5", "(4):MPC>=2", "(5):MPC>=1&MPC<2", "(6):MPC<1"), 2))
method=c(rep("Burden", 6), rep("mirage-vs", 6))
pvalue=c(round(-log(proband_para_est$pval, base=10), 2), round(-log(proband_para_est$eta_pval, base=10), 2))
summary=data.frame(var.group=var_group, pvalue=pvalue, method=method)
ggplot(summary, aes(x=var.group, y=pvalue, fill=method)) + 
   geom_bar(stat="identity", 
           position=position_dodge())+
  ylab(expression(-log[10](pvalue)))+
  theme(legend.title=element_blank())+
  xlab(" variant groups")+
  ggtitle(" p value comparison between Burden and MIRAGE-VS")+
  theme(plot.title = element_text(hjust = 0.5, size=10))+  #center the title 
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=10))
  #ylab(expression(paste(hat(eta))))+ 
  #guides(fill=guide_legend(title=NULL))+
  #ylim(0.05,0.15)+
  # geom_hline(yintercept=0.1,linetype="dashed", color = "red")
```

### gene set analysis using mirage taking into account gene level information

* $\gamma=6$ for PLI variant groups and $\gamma=3$ for MPC groups when running mirage.
* apply filter `Gnomad_non_neuro_AF<0.05` 

```{r,echo=F, eval=F}
### !!!!!!!!!!!!!!!!! DO NOT RUN: it takes about ~20 min  to run; not really, heavily depends on the seeds  ####### 
############  gene set 
gene_set=ASC_new_sample_GI %>%  filter(Gnomad_non_neuro_AF<0.05) %>% filter(Gene %in% Constraint_Gene) %>% select(Variant, Gene, Transmitted_proband, Untransmitted_proband, Group_Index) %>% drop_na()
#mirage_result=mirage(data.frame(gene_set),n1=5869, n2=5869, gamma=c(6,6,6,3,3,3))
######## this case takes about 2 hours to finish running 
#set.seed(Sys.time()) # set a unique random seed 
mirage_result1=mirage(data.frame(gene_set),n1=num.family, n2=num.family)# input data must be dataframe
#write.csv(mirage_result1$BF.PP.gene, file="../output/KyleData/BF.proband.ConstraintGene.csv")
#saveRDS(mirage_result1$BF.all, file="../output/KyleData/BF.proband.ConstraintGene.BF.all.rds") #this saves Bayes factor for all variants in each gene, no need to re-run the program 

####### this case takes close to 2 hours to finish running 
#set.seed(Sys.time()) # set a unique random seed 
#mirage_result2=mirage(data.frame(gene_set),n1=num.family, n2=num.family,gamma=c(6,6,6,3,3,3), sigma=2, eta.init=0.01, delta.init=0.01)

#############  this case takes a couple of minutes 
#set.seed(Sys.time()) # set a unique random seed 
#mirage_result3=mirage(data.frame(gene_set),n1=num.family, n2=num.family,gamma=c(6,6,6,3,3,3), sigma=2, eta.init=0.0001, delta.init=0.0001)



############# this case takes about 1.5 hour
#set.seed(Sys.time()) # set a unique random seed 
#mirage_result4=mirage(data.frame(gene_set),n1=num.family, n2=num.family,gamma=c(6,6,6,3,3,3), sigma=2, eta.init=0.5, delta.init=0.5)
```


variant category |parameter | estimate |  p value |
-----------------|-----|-----|------|--------
\ |$\hat{\delta}$ | 0.0911 | 0
(1):PLI>=0.995|$\hat{\eta}_1$ | 0.1509    | 0
(2):0.5<=pLI<0.995|$\hat{\eta}_2$ | $1.14\times 10^{-48}$    | 1
(3):pLI<0.5|$\hat{\eta}_3$ | 0.5452    | $8.72\times 10^{-11}$
(4):MPC>=2|$\hat{\eta}_4$ | $1.03\times 10^{-8}$    | 1
(5):1<=MPC<2| $\hat{\eta}_5$ | 0.0258    | $1.75\times 10^{-16}$
(6):0<=MPC<1| $\hat{\eta}_6$ | 0.0263    | $1.41\times 10^{-10}$


```{r, echo=F}
var_group=c("(1):PLI>=0.995", "(2):pLI>=0.5&pLI<0.995", "(3):pLI<0.5", "(4):MPC>=2", "(5):MPC>=1&MPC<2", "(6):MPC<1")
estimate=c(0.1509, 0, 0.5452, 0, 0.0258, 0.0263)
summary=data.frame(var.group=var_group, estimate=estimate)
ggplot(summary, aes(x=var.group, y=estimate, fill=var.group)) + 
   geom_bar(stat="identity", position=position_dodge())+
  theme(legend.title=element_blank())+
  xlab("variant groups")+ylab(expression(paste(hat(eta))))+
  ggtitle("")+
  theme(plot.title = element_text(hjust = 0.5, size=10))+  #center the title 
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=10))
```

Below are top ranked genes. 
```{r, echo=F}
BF_all=readRDS("../output/KyleData/BF.proband.ConstraintGene.BF.all.rds")
BF_proband_ConstraintGene=as_tibble(read.csv("../output/kyleData/BF.proband.ConstraintGene.csv"))
BF_proband_ConstraintGene_sorted=BF_proband_ConstraintGene%>%arrange(desc(post.prob))
#length(intersect(BF_proband_AllGene_sorted$Gene[1:100], ASD_102_Gene))
BF_proband_ConstraintGene_sorted
#BF_proband_AllGene_sorted %>% filter(Gene %in% ASD_102_Gene) %>% print(n=102)
```

#### Top genes 

Those top genes with large BF  do not have burden. 


```{r, echo=F}
num_gene=10
topgene=BF_proband_ConstraintGene_sorted$Gene[1:num_gene]
Transmitted_proband=numeric(); Untransmitted_proband=numeric(); OR=numeric()
for (i in 1:length(topgene))
{
Transmitted_proband[i]=sum(ASC_new_sample_GI%>%filter(Gene==topgene[i] & Gnomad_non_neuro_AF<=0.5)%>%select(Transmitted_proband)%>%pull())
Untransmitted_proband[i]=sum(ASC_new_sample_GI%>%filter(Gene==topgene[i] & Gnomad_non_neuro_AF<=0.5)%>%select(Untransmitted_proband)%>%pull())
burden_test=fisher.test(matrix(c(Transmitted_proband[i],num.family, Untransmitted_proband[i], num.family), nrow=2))
OR[i]=burden_test$estimate
}
topgene_summary=tibble(Gene=topgene, BF=BF_proband_ConstraintGene_sorted$BF[1:10], Transmitted_proband=Transmitted_proband, Untransmitted_proband=Untransmitted_proband, OR=OR)
topgene_summary
```


#### Vairants driving the signal in top gene 

```{r, echo=F, eval=F}
intergrand=function(aa, var.case, var.contr, bar.gamma, sig, N1, N0)
{
  ff=dbinom(var.case, sum(var.case, var.contr), aa*N1/(aa*N1+N0))*dgamma(aa, bar.gamma*sig, sig)
  return(ff)
}

# calculate the bayes factor of a single variant via integration
BF.var.inte=function(var.case, var.contr, bar.gamma, sig, N1, N0)
{
  marglik0.CC <- dbinom(var.case, sum(var.case, var.contr), N1/(N1+N0))    # Under H0: gamma=1
  
  marglik1.CC <- integrate(intergrand, var.case, var.contr, bar.gamma, sig, N1, N0, low=0, upper=100, stop.on.error=F)$value # Under H1: gamma~gamma(gamma.mean*sigma, sigma)
  BF.var <- marglik1.CC/marglik0.CC
  
  return(BF.var)
}

```

variants that drive the BF of top genes. Those variants surviving after filter `AF<5%`  has close to 10 times untransmitted variants than transmitted, thereby drive the BF to a high number.  

```
* 148 5:7757570:TGGCCGTGTTCAACATGGTAAGTCCCAGAGCAC:T                                 ADCY2        0.00882                  15              219           1

> BF.var.inte(15, 219, 3, 3, num.family, num.family)
[1] 6.321461e+36

In gene ADCY2, there is one variant with `15      219        1 6.015290e+39              1` driving the signal.

* 17:31232075:A:T  NF1      11      123        5 1.022707e+18              5

* 1:240207775:C:T FMN2      23      130        6 202948206699  6 

* 6:31271622:C:CGGAG HLA-C       4       43        3 3.113611e+02    
6:31271643:A:T HLA-C       3       43        6 1.513167e+03              6

* 16:72109460:GAGCT:G DHX38      35      122        3 4.678945e+04              3

```

 

  