---
title: "Simulation study"
author: "Shengtong Han"
output: html_document
---

```{r, echo=F, warning=F}
library(ggplot2)
library(gridExtra)
library(matrixStats)
library(plotROC)
library(grid)
library(tidyverse)
library(cowplot)
```


```{r, echo=F}
loadRData <- function(fileName){
#loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}
```



<!-- Add your analysis here -->
## Data Generation

Basically, there are two sequential levels when generating the data. First under null hypothesis, generate total number of variants in cases and controls, i.e., AF $q_{ij}^{(0)} \sim Beta(\alpha_0, \beta_0)$, $X_{1ij}+X_{0ij} \sim Pois (N1+N0, q_{ij}^{(0)})$,  filter out variants will null mutations, then re-distribute all mutations in effective variants into cases and controls depending on the risk status via conditional binomial distribution.     

* gene level: $U_i$ denote the risk status of gene $i$, $U_i \sim Ber(1, \delta)$. All genes share the same risk probability $\delta$. 
* variant level:
    +  $U_i=0$, all variants for gene $i$ are non-causal, which is under null hypothesis. Given the generated $X_{1ij}+X_{0ij}$, split into case and controls by conditional binomial distribution, with $p=\frac{N1}{N1+N0}$  
    + $U_i=1$,  gene $i$ is a causal gene, the variant $(i,j)$ whose risk status is denoted by $Z_{ij}$ is generated as $Z_{ij} \sim Ber(1, \pi(\eta))$, $\pi(\eta)$ is a function linking annotations to the probability of being causal. 
          *  $Z_{ij}=0$ (which is under null),  given the generated $X_{1ij}+X_{0ij}$, split into case and controls by conditional binomial distribution, with $p=\frac{N1}{N1+N0}$
          *   $Z_{ij}=1$ (which is under alternative), AF $q_{ij}^{(1)} \sim Beta(\alpha, \beta)$, $\gamma_{ij} \sim Gamma(\bar{\gamma}*\sigma, \sigma)$,  $X_{1ij}+X_{0ij} \sim Pois(N1+N0, q_{ij}^{(1)})$, split into case and control by conditional binomial distribution with $p=\frac{N1*\gamma_{ij}}{N1*\gamma_{ij}+N0}$. 
          
Filtering step: filter variants that have null variant counts in both cases and controls.  

Notations: 

* N1, N0 are sample sizes in cases and controls 
* $q_{ij}$ is allele frequency for variant $(i,j)$
* $\bar{\gamma}$ relative risk 


$\pi(\eta)$ is the link function between annotations and prior probability and the interest is in estimating $\eta$.  

## Disjoint group priors 


### Power comparison between MIRAGE-VS and other methods

We simulated 100  variants in one category. $N1=N0=1000, 3000, 5000$, $\eta=0.1, 0.2, 0.3, 0.4$, $\bar{\gamma}=5$,  $\alpha=\alpha_0=0.1$, $\beta=2000, \beta_0=1000$. We independetly run Monte Carlo  100 times and calculate the true positive rate for MIRAGE-VS, burden test and SKATO.  Note here there is no gene information. MIRAGE-VS basically estimates the proportion of risk variants $\hat{\eta}$, and performs the likelihood ratio test to get p value.  



```{r, echo=F}
sig.cutoff=0.05
########### eta=0.1
SS1000eta01=loadRData("../output/Power_Analysis_MIRAGE-VS/SampleSize1000_eta0.1.RData")
SS3000eta01=loadRData("../output/Power_Analysis_MIRAGE-VS/SampleSize3000_eta0.1.RData")
SS5000eta01=loadRData("../output/Power_Analysis_MIRAGE-VS/SampleSize5000_eta0.1.RData")
SS1000eta01_mirage=as.numeric(as_tibble(SS1000eta01) %>% filter(MIRAGE.pvalue<sig.cutoff) %>% tally())
SS1000eta01_burden=as.numeric(as_tibble(SS1000eta01) %>% filter(Fisher.pvalue<sig.cutoff) %>% tally())
SS1000eta01_skato=as.numeric(as_tibble(SS1000eta01) %>% filter(SKATO.pvalue<sig.cutoff) %>% tally())
SS3000eta01_mirage=as.numeric(as_tibble(SS3000eta01) %>% filter(MIRAGE.pvalue<sig.cutoff) %>% tally())
SS3000eta01_burden=as.numeric(as_tibble(SS3000eta01) %>% filter(Fisher.pvalue<sig.cutoff) %>% tally())
SS3000eta01_skato=as.numeric(as_tibble(SS3000eta01) %>% filter(SKATO.pvalue<sig.cutoff) %>% tally())
SS5000eta01_mirage=as.numeric(as_tibble(SS5000eta01) %>% filter(MIRAGE.pvalue<sig.cutoff) %>% tally())
SS5000eta01_burden=as.numeric(as_tibble(SS5000eta01) %>% filter(Fisher.pvalue<sig.cutoff) %>% tally())
SS5000eta01_skato=as.numeric(as_tibble(SS5000eta01) %>% filter(SKATO.pvalue<sig.cutoff) %>% tally())
powereta01=tibble(Sample_Size=c(1000, 3000, 5000), MIRAGE_VS=c(SS1000eta01_mirage, SS3000eta01_mirage, SS5000eta01_mirage), Burden=c(SS1000eta01_burden, SS3000eta01_burden, SS5000eta01_burden), SKATO=c(SS1000eta01_skato, SS3000eta01_skato, SS5000eta01_skato))
powereta01_gather=powereta01 %>% gather(Method,TPR, MIRAGE_VS:SKATO)
g1=ggplot(powereta01_gather, aes(x=Sample_Size, y=TPR/100, group=Method))+
  geom_line(aes(color=Method), size=0.8)+
  geom_point(aes(color=Method, shape=Method))+
  xlab("N1=N0")+ 
  ylab("True positive rate")+
  ggtitle(expression(paste(eta, "=0.1")))+
  theme(plot.title = element_text(hjust = 0.5, size=10))+
  theme(axis.text.x = element_text(angle = 60, hjust = 1))


########### eta=0.2
SS1000eta02=loadRData("../output/Power_Analysis_MIRAGE-VS/SampleSize1000_eta0.2.RData")
SS3000eta02=loadRData("../output/Power_Analysis_MIRAGE-VS/SampleSize3000_eta0.2.RData")
SS5000eta02=loadRData("../output/Power_Analysis_MIRAGE-VS/SampleSize5000_eta0.2.RData")
SS1000eta02_mirage=as.numeric(as_tibble(SS1000eta02) %>% filter(MIRAGE.pvalue<sig.cutoff) %>% tally())
SS1000eta02_burden=as.numeric(as_tibble(SS1000eta02) %>% filter(Fisher.pvalue<sig.cutoff) %>% tally())
SS1000eta02_skato=as.numeric(as_tibble(SS1000eta02) %>% filter(SKATO.pvalue<sig.cutoff) %>% tally())
SS3000eta02_mirage=as.numeric(as_tibble(SS3000eta02) %>% filter(MIRAGE.pvalue<sig.cutoff) %>% tally())
SS3000eta02_burden=as.numeric(as_tibble(SS3000eta02) %>% filter(Fisher.pvalue<sig.cutoff) %>% tally())
SS3000eta02_skato=as.numeric(as_tibble(SS3000eta02) %>% filter(SKATO.pvalue<sig.cutoff) %>% tally())
SS5000eta02_mirage=as.numeric(as_tibble(SS5000eta02) %>% filter(MIRAGE.pvalue<sig.cutoff) %>% tally())
SS5000eta02_burden=as.numeric(as_tibble(SS5000eta02) %>% filter(Fisher.pvalue<sig.cutoff) %>% tally())
SS5000eta02_skato=as.numeric(as_tibble(SS5000eta02) %>% filter(SKATO.pvalue<sig.cutoff) %>% tally())
powereta02=tibble(Sample_Size=c(1000, 3000, 5000), MIRAGE_VS=c(SS1000eta02_mirage, SS3000eta02_mirage, SS5000eta02_mirage), Burden=c(SS1000eta02_burden, SS3000eta02_burden, SS5000eta02_burden), SKATO=c(SS1000eta02_skato, SS3000eta02_skato, SS5000eta02_skato))
powereta02_gather=powereta02 %>% gather(Method,TPR, MIRAGE_VS:SKATO)
g2=ggplot(powereta02_gather, aes(x=Sample_Size, y=TPR/100, group=Method))+
  geom_line(aes(color=Method), size=0.8)+
  geom_point(aes(color=Method, shape=Method))+
  xlab("N1=N0")+ 
  ylab("True positive rate")+
  ggtitle(expression(paste(eta, "=0.2")))+
  theme(plot.title = element_text(hjust = 0.5, size=10))+
  theme(axis.text.x = element_text(angle = 60, hjust = 1))
#g2

########### eta=0.3
SS1000eta03=loadRData("../output/Power_Analysis_MIRAGE-VS/SampleSize1000_eta0.3.RData")
SS3000eta03=loadRData("../output/Power_Analysis_MIRAGE-VS/SampleSize3000_eta0.3.RData")
SS5000eta03=loadRData("../output/Power_Analysis_MIRAGE-VS/SampleSize5000_eta0.3.RData")
SS1000eta03_mirage=as.numeric(as_tibble(SS1000eta03) %>% filter(MIRAGE.pvalue<sig.cutoff) %>% tally())
SS1000eta03_burden=as.numeric(as_tibble(SS1000eta03) %>% filter(Fisher.pvalue<sig.cutoff) %>% tally())
SS1000eta03_skato=as.numeric(as_tibble(SS1000eta03) %>% filter(SKATO.pvalue<sig.cutoff) %>% tally())
SS3000eta03_mirage=as.numeric(as_tibble(SS3000eta03) %>% filter(MIRAGE.pvalue<sig.cutoff) %>% tally())
SS3000eta03_burden=as.numeric(as_tibble(SS3000eta03) %>% filter(Fisher.pvalue<sig.cutoff) %>% tally())
SS3000eta03_skato=as.numeric(as_tibble(SS3000eta03) %>% filter(SKATO.pvalue<sig.cutoff) %>% tally())
SS5000eta03_mirage=as.numeric(as_tibble(SS5000eta03) %>% filter(MIRAGE.pvalue<sig.cutoff) %>% tally())
SS5000eta03_burden=as.numeric(as_tibble(SS5000eta03) %>% filter(Fisher.pvalue<sig.cutoff) %>% tally())
SS5000eta03_skato=as.numeric(as_tibble(SS5000eta03) %>% filter(SKATO.pvalue<sig.cutoff) %>% tally())
powereta03=tibble(Sample_Size=c(1000, 3000, 5000), MIRAGE_VS=c(SS1000eta03_mirage, SS3000eta03_mirage, SS5000eta03_mirage), Burden=c(SS1000eta03_burden, SS3000eta03_burden, SS5000eta03_burden), SKATO=c(SS1000eta03_skato, SS3000eta03_skato, SS5000eta03_skato))
powereta03_gather=powereta03 %>% gather(Method,TPR, MIRAGE_VS:SKATO)
g3=ggplot(powereta03_gather, aes(x=Sample_Size, y=TPR/100, group=Method))+
  geom_line(aes(color=Method), size=0.8)+
  geom_point(aes(color=Method, shape=Method))+
  xlab("N1=N0")+ 
  ylab("True positive rate")+
  ggtitle(expression(paste(eta, "=0.3")))+
  theme(plot.title = element_text(hjust = 0.5, size=10))+
  theme(axis.text.x = element_text(angle = 60, hjust = 1))
#g3

########### eta=0.4
SS1000eta04=loadRData("../output/Power_Analysis_MIRAGE-VS/SampleSize1000_eta0.4.RData")
SS3000eta04=loadRData("../output/Power_Analysis_MIRAGE-VS/SampleSize3000_eta0.4.RData")
SS5000eta04=loadRData("../output/Power_Analysis_MIRAGE-VS/SampleSize5000_eta0.4.RData")
SS1000eta04_mirage=as.numeric(as_tibble(SS1000eta04) %>% filter(MIRAGE.pvalue<sig.cutoff) %>% tally())
SS1000eta04_burden=as.numeric(as_tibble(SS1000eta04) %>% filter(Fisher.pvalue<sig.cutoff) %>% tally())
SS1000eta04_skato=as.numeric(as_tibble(SS1000eta04) %>% filter(SKATO.pvalue<sig.cutoff) %>% tally())
SS3000eta04_mirage=as.numeric(as_tibble(SS3000eta04) %>% filter(MIRAGE.pvalue<sig.cutoff) %>% tally())
SS3000eta04_burden=as.numeric(as_tibble(SS3000eta04) %>% filter(Fisher.pvalue<sig.cutoff) %>% tally())
SS3000eta04_skato=as.numeric(as_tibble(SS3000eta04) %>% filter(SKATO.pvalue<sig.cutoff) %>% tally())
SS5000eta04_mirage=as.numeric(as_tibble(SS5000eta04) %>% filter(MIRAGE.pvalue<sig.cutoff) %>% tally())
SS5000eta04_burden=as.numeric(as_tibble(SS5000eta04) %>% filter(Fisher.pvalue<sig.cutoff) %>% tally())
SS5000eta04_skato=as.numeric(as_tibble(SS5000eta04) %>% filter(SKATO.pvalue<sig.cutoff) %>% tally())
powereta04=tibble(Sample_Size=c(1000, 3000, 5000), MIRAGE_VS=c(SS1000eta04_mirage, SS3000eta04_mirage, SS5000eta04_mirage), Burden=c(SS1000eta03_burden, SS3000eta03_burden, SS5000eta04_burden), SKATO=c(SS1000eta04_skato, SS3000eta04_skato, SS5000eta04_skato))
powereta04_gather=powereta04 %>% gather(Method,TPR, MIRAGE_VS:SKATO)
g4=ggplot(powereta04_gather, aes(x=Sample_Size, y=TPR/100, group=Method))+
  geom_line(aes(color=Method), size=0.8)+
  geom_point(aes(color=Method, shape=Method))+
  xlab("N1=N0")+ 
  ylab("True positive rate")+
  ggtitle(expression(paste(eta, "=0.4")))+
  theme(plot.title = element_text(hjust = 0.5, size=10))+
  theme(axis.text.x = element_text(angle = 60, hjust = 1))
#g4

grid.arrange(g1, g2, g3, g4, nrow=2)

```


###  All genes are risk genes, fix $\delta=1$, only estimate $\eta$



* parameter estimate: (I) relative risk effect, $\bar{\gamma}$ on estimating $\eta$ 

Since variant groups are assumed to be independent, it suffices to demonstrate the parameter estimate only for one risk variant group.  



Parameter settings: N1=N0=3000, $\alpha=\alpha_0=0.1$, $\beta=2000, \beta_0=1000$. 100 genes, each having 1000 variants with $\eta_i=0.1$ risk variants, but the actural $\eta_i$ is varying for each generated data set because of the filtering. $\bar{\gamma}=2,3,4,5$ and with each $\bar{\gamma}$, perform 100 independent runs. 



```{r, echo=F}
num.gamma=4
all.eta=matrix(nrow=100, ncol=num.gamma)
bargamma_2=load("../output/Varybargamma/gammabar_2.RData")
all.eta[,1]=all.pi[,1]
bargamma_3=load("../output/Varybargamma/gammabar_3.RData")
all.eta[,2]=all.pi[,1]
bargamma_4=load("../output/Varybargamma/gammabar_4.RData")
all.eta[,3]=all.pi[,1]
bargamma_5=load("../output/Varybargamma/gammabar_5.RData")
all.eta[,4]=all.pi[,1]
#bargamma_6=load("../output/Varybargamma/bargamma_6.RData")
#all.eta[,5]=all.pi[,1]
colnames(all.eta)=2:(2+num.gamma-1)

eta.mean=c(mean(all.eta[which(all.eta[,1]>0),1]), mean(all.eta[which(all.eta[,2]>0),2]), mean(all.eta[which(all.eta[,3]>0),3]), mean(all.eta[which(all.eta[,4]>0),4]))
eta.sd=c(sd(all.eta[which(all.eta[,1]>0),1]), sd(all.eta[which(all.eta[,2]>0),2]), sd(all.eta[which(all.eta[,3]>0),3]), sd(all.eta[which(all.eta[,4]>0),4]))
```



```{r, echo=F}
bar.gamma=2:5
eta.summary=data.frame(mean=eta.mean, sd=eta.sd, bar.gamma=bar.gamma)
p1=ggplot(eta.summary, aes(x=bar.gamma, y=mean, group=1)) + 
   geom_point() +
  geom_pointrange(aes(ymin=mean-sd, ymax=mean+sd))+
  ggtitle("N1=N0=3000")+
  theme(plot.title = element_text(hjust = 0.5, size=10))+  #center the title 
  xlab(expression(paste(bar(gamma))))+
  ylab(expression(paste(hat(eta))))+ 
  guides(fill=guide_legend(title=NULL))+
  ylim(0.05,0.15)+
   geom_hline(yintercept=0.1,linetype="dashed", color = "red")
```  
  


* Parameter estimate (II): sample size effect on estimating $\eta$

Parameter settings: N1=N0=1000, 3000, 5000, $\alpha=\alpha_0=0.1$, $\beta=2000, \beta_0=1000$. 100 genes, each having 1000 variants with $\eta_i=0.1$ risk variants, but the actural $\eta_i$ is varying for each generated data set because of the filtering. $\bar{\gamma}=5$.   For each fixed sample size,  perform 100 independent runs. 



```{r, echo=F}
num.sample.size=3
all.eta=matrix(nrow=100, ncol=num.sample.size)
load("../output/Varysamplesize/sample.size.1000.RData")
all.eta[,1]=all.pi[,1]
load("../output/Varysamplesize/sample.size.3000.RData")
all.eta[,2]=all.pi[,1]
load("../output/Varysamplesize/sample.size.5000.RData")
all.eta[,3]=all.pi[,1]
#bargamma_6=load("../output/Varybargamma/bargamma_6.RData")
#all.eta[,5]=all.pi[,1]
colnames(all.eta)=c(1000, 3000, 5000)

eta.mean=c(mean(all.eta[which(all.eta[,1]>0),1]), mean(all.eta[which(all.eta[,2]>0),2]), mean(all.eta[which(all.eta[,3]>0),3]))
eta.sd=c(sd(all.eta[which(all.eta[,1]>0),1]), sd(all.eta[which(all.eta[,2]>0),2]), sd(all.eta[which(all.eta[,3]>0),3]))
```



```{r, echo=F}
sample.size=c(1000, 3000, 5000)
eta.summary=data.frame(mean=eta.mean, sd=eta.sd, sample.size=sample.size)
p2=ggplot(eta.summary, aes(x=sample.size, y=mean, group=1)) + 
   geom_point() +
  geom_pointrange(aes(ymin=mean-sd, ymax=mean+sd))+
  ggtitle(expression(paste(bar(gamma), "=5")))+
  theme(plot.title = element_text(hjust = 0.5, size=10))+  # center the title 
  xlab(expression(paste("N1=N0 ")))+
  ylab(expression(paste(hat(eta))))+ 
  guides(fill=guide_legend(title=NULL))+
  ylim(0.05,0.15)+
   geom_hline(yintercept=0.1,linetype="dashed", color = "red")
pdf("../../Figure/para_est_risk_gene_only.pdf")
grid.arrange(p1, p2, top=grid.text(expression(paste("Estimate of ", eta," across 100 replicates"))), bottom=grid.text(expression(paste(alpha, "=0.1,", alpha[0], "=0.1,", beta, "=2000,", beta[0], "=1000,", eta[i], "=0.1"))), nrow=1)
dev.off()
```  



* power comparison with other methods 


For every simulated risk gene, three different methods are used to test the power of detecting risk genes. Significance level of 0.05 is used as cutoff.  Burnden test looks at the variants in cases and controls and performs the enrichment analysis for every gene. SKATO tests the significance of effect size and generate p value without covariates. MIRAGE-LRT first estimates the parameter $\eta$, then does a likelihood ratio test and returns p value by $\chi^2_k$ ($k$ is the number of unknown parameters $\eta$). 

**Case 1: every risk gene only has one risk variant group with the proportion of $\eta$ and fixed $\bar{\gamma}$** 

Parameter settings: N1=N0=3000 $\alpha=\alpha_0=0.1$, $\beta=2000, \beta_0=1000$. 100 genes, each having 1000 variants with $\eta=0.1, 0.2, 0.3$ risk variants, but the actural $\eta$ is varying for each generated data set because of the filtering. $\bar{\gamma}=5$.  For every $\eta$, perform 100 independent runs. 




```{r, echo=F, warning=F}
library(matrixStats)
load("../output/Varyeta/eta_0.1.RData")
TP_eta_0.1=TP
TP_eta_0.1_effect=TP_eta_0.1[apply(TP_eta_0.1!=0, 1, all),] 
load("../output/Varyeta/eta_0.2.RData")
TP_eta_0.2=TP
TP_eta_0.2_effect=TP_eta_0.2[apply(TP_eta_0.2!=0, 1, all),] 
load("../output/Varyeta/eta_0.3.RData")
TP_eta_0.3=TP
TP_eta_0.3_effect=TP_eta_0.3[apply(TP_eta_0.3!=0, 1, all),] 
eta.mean=c(colMeans(TP_eta_0.1_effect), colMeans(TP_eta_0.2_effect), colMeans(TP_eta_0.3_effect))
eta.sd=c(colSds(TP_eta_0.1_effect), colSds(TP_eta_0.2_effect), colSds(TP_eta_0.3_effect))
method1=rep(c("MIRAGE-LRT", "Burden", "SKATO"),each=3)

load("../output/Varybargamma_RiskGene_OneRiskVarGroup/bargamma_1.RData")
TP_bargamma_1=TP
TP_bargamma_1_effect=TP_bargamma_1[apply(TP_bargamma_1!=0, 1, all),] 
load("../output/Varybargamma_RiskGene_OneRiskVarGroup/bargamma_2.RData")
TP_bargamma_2=TP
TP_bargamma_2_effect=TP_bargamma_2[apply(TP_bargamma_2!=0, 1, all),] 
load("../output/Varybargamma_RiskGene_OneRiskVarGroup/bargamma_3.RData")
TP_bargamma_3=TP
TP_bargamma_3_effect=TP_bargamma_3[apply(TP_bargamma_3!=0, 1, all),] 
load("../output/Varybargamma_RiskGene_OneRiskVarGroup/bargamma_4.RData")
TP_bargamma_4=TP
TP_bargamma_4_effect=TP_bargamma_4[apply(TP_bargamma_4!=0, 1, all),] 
load("../output/Varyeta/eta_0.1.RData")
TP_bargamma_5=TP
TP_bargamma_5_effect=TP_bargamma_5[apply(TP_bargamma_5!=0, 1, all),] 

bargamma.mean=c( colMeans(TP_bargamma_2_effect), colMeans(TP_bargamma_3_effect), colMeans(TP_bargamma_4_effect), colMeans(TP_bargamma_5_effect))
bargamma.sd=c(colSds(TP_bargamma_2_effect), colSds(TP_bargamma_3_effect), colSds(TP_bargamma_4_effect), colSds(TP_bargamma_5_effect))
method2=rep(c("MIRAGE-LRT", "Burden", "SKATO"),each=4)
```


```{r, echo=F}
eta=rep(c(0.1, 0.2, 0.3),3)
eta.summary=data.frame(eta=eta, mean=c(eta.mean[c(1,4,7)], eta.mean[c(2,5,8)], eta.mean[c(3,6,9)]), sd=c(eta.sd[c(1,4,7)], eta.sd[c(2,5,8)], eta.sd[c(3,6,9)]), method=method1)
p1=ggplot(eta.summary, aes(x=eta, y=mean, color=method, group=method)) + 
   geom_line() +
   geom_point()+
  geom_pointrange(aes(ymin=mean-sd, ymax=mean+sd))+
  xlab(expression(paste(eta)))+
  ylab("Estimated proportion of risk genes")+
  ggtitle(expression(paste(bar(gamma), "=5")))+
  theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title
  #xlab(expression(paste(bar(gamma), "=5;", "N1=N0 ")))+
  #ylab(expression(paste(hat(eta))))+ 
  #guides(fill=guide_legend(title=NULL))+
  #ylim(0.05,0.15)+
  # geom_hline(yintercept=0.1,linetype="dashed", color = "red")
bargamma=rep(2:5,3)
bargamma.summary=data.frame(bargamma=bargamma, mean=c(bargamma.mean[c(1,4,7,10)], bargamma.mean[c(2,5,8,11)], bargamma.mean[c(3,6,9,12)]), sd=c(bargamma.sd[c(1,4,7,10)], bargamma.sd[c(2,5,8,11)], bargamma.sd[c(3,6,9,12)]), method=method2)
p2=ggplot(bargamma.summary, aes(x=bargamma, y=mean, color=method, group=method)) + 
   geom_line() +
   geom_point()+
  geom_pointrange(aes(ymin=mean-sd, ymax=mean+sd))+
  xlab(expression(paste(bar(gamma))))+
  ylab("Estimated proportion of risk genes")+
ggtitle(expression(paste(eta, "=0.1")))+
  theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title

grid.arrange(p1, p2, bottom=grid.text(expression(paste(alpha, "=0.1,", alpha[0], "=0.1,", beta, "=2000,", beta[0], "=1000"))), nrow=1)
```



**Case 2: every risk gene has multiple risk variant groups with varying proportion of $\eta$ and fixed $\bar{\gamma}$** 

Parameter settings: N1=N0=3000 $\alpha=\alpha_0=0.1$, $\beta=2000, \beta_0=1000$. 100 genes, each having 1000 variants in three different groups, the first group has 30% variant, the second has 40% and the rest 30% are in the third group. In each group of every gene, the proportion  of risk genes  $\eta$ is varying at 0.01, 0.05, 0.1 respectively.  $\bar{\gamma}=2, 3,4, 5$.  For every $\bar{\gamma}$, perform 100 independent runs. 



```{r, echo=F, warning=F}
load("../output/Varybargamma_RiskGene_MixtureVariant/bargamma_2.RData")
TP_bargamma_2=TP
TP_bargamma_2_effect=TP_bargamma_2[apply(TP_bargamma_2!=0, 1, all),] 
load("../output/Varybargamma_RiskGene_MixtureVariant/bargamma_3.RData")
TP_bargamma_3=TP
TP_bargamma_3_effect=TP_bargamma_3[apply(TP_bargamma_3!=0, 1, all),] 
load("../output/Varybargamma_RiskGene_MixtureVariant/bargamma_4.RData")
TP_bargamma_4=TP
TP_bargamma_4_effect=TP_bargamma_4[apply(TP_bargamma_4!=0, 1, all),] 
load("../output/Varybargamma_RiskGene_MixtureVariant/bargamma_5.RData")
TP_bargamma_5=TP
TP_bargamma_5_effect=TP_bargamma_5[apply(TP_bargamma_5!=0, 1, all),] 

tp.mean=c(colMeans(TP_bargamma_2_effect), colMeans(TP_bargamma_3_effect), colMeans(TP_bargamma_4_effect), colMeans(TP_bargamma_5_effect))
tp.sd=c(colSds(TP_bargamma_2_effect), colSds(TP_bargamma_3_effect), colSds(TP_bargamma_4_effect), colSds(TP_bargamma_5_effect))
method=rep(c("MIRAGE-LRT", "Burden", "SKATO"),each=4)
```


```{r, echo=F}
bargamma=rep(2:5,3)
tp.summary=data.frame(bargamma=bargamma, mean=c(tp.mean[c(1,4,7,10)], tp.mean[c(2,5,8,11)], tp.mean[c(3,6,9, 12)]), sd=c(tp.sd[c(1,4,7,10)], tp.sd[c(2,5,8,11)], tp.sd[c(3,6,9,12)]), method=method)
ggplot(tp.summary, aes(x=bargamma, y=mean, color=method, group=method)) + 
   geom_line() +
   geom_point()+
  geom_pointrange(aes(ymin=mean-sd, ymax=mean+sd))+
  xlab(expression(paste(bar(gamma))))+
  ylab("Estimated proportion of risk genes")
  #xlab(expression(paste(bar(gamma), "=5;", "N1=N0 ")))+
  #ylab(expression(paste(hat(eta))))+ 
  #guides(fill=guide_legend(title=NULL))+
  #ylim(0.05,0.15)+
  # geom_hline(yintercept=0.1,linetype="dashed", color = "red")
```




**Case 3: every risk gene has multiple risk variant groups with varying proportion of $\eta$ and varying $\bar{\gamma}$** 

Parameter settings: N1=N0=3000 $\alpha=\alpha_0=0.1$, $\beta=2000, \beta_0=1000$. 100 genes, each having 1000 variants in three different groups, the first group has 30% variants, the second has 40% and the rest 30% are in the third group. In each variant group of every gene, the proportion  of risk variants  $\eta$ is varying at 0.01, 0.05, 0.1 and every risk category has its own    $\bar{\gamma}=5, 3,1$ respectively. The basic idea is that the rarer the varinat is, the more effect size it tends to have.    Perform 100 independent runs. 

```{r, echo=F, warning=F}
load("../output/Var_specific_bargamma_RiskGene_MixtureVariant/cate_specific_bargamma.RData")
TP_var_specific_bargamma=TP
TP_var_specific_bargamma_effect=TP_var_specific_bargamma[apply(TP_var_specific_bargamma!=0, 1, all),] 

tp.mean=colMeans(TP_var_specific_bargamma_effect)
tp.sd=colSds(TP_var_specific_bargamma_effect)
method=rep(c("MIRAGE-LRT", "Burden", "SKATO"))
```

```{r, echo=F}
tp.summary=data.frame(mean=tp.mean, sd=tp.sd, method=method)
ggplot(tp.summary, aes(x=method, y=mean, fill=method)) + 
   geom_bar(stat="identity", 
           position=position_dodge()) +
   geom_errorbar(aes(ymin=mean-tp.sd, ymax=mean+tp.sd), width=.2,
                 position=position_dodge(.9))+
  ylab("Estimated proportion of risk genes")
  #xlab(expression(paste(bar(gamma), "=5;", "N1=N0 ")))+
  #ylab(expression(paste(hat(eta))))+ 
  #guides(fill=guide_legend(title=NULL))+
  #ylim(0.05,0.15)+
  # geom_hline(yintercept=0.1,linetype="dashed", color = "red")
```






###  Mixture of risk genes and non-risk genes $0<\delta<1$, estimate both $\eta, \delta$

Since the simulated data is a mixture of risk genes and non-risk genes, drawing ROC curve is one way to test the power of discriminating risk genes of  different methods. For MIRAGE, Bayes factor of every gene was calculated and used to plot ROC, called MIRAGE-BF. 


#### Power comparison 


**case 1: one risk gene has only one risk variant category with fixed $\bar{\gamma}$**

Parameter settings: N1=N0=3000 $\alpha=\alpha_0=0.1$, $\beta=2000, \beta_0=1000$. 100 genes, each having 1000 variants with $\eta=0.03, 0.07, 0.1, 0.2$ risk variants, but the actural $\eta$ is varying for each generated data set because of the filtering. $\delta=0.5$, i.e. half genes are risk genes and the rest half are nonrisk genes. $\bar{\gamma}=5$. 


```{r, echo=F, warning=F}
load("../output/Varyeta_MixedGene_OneRiskVarGroup/eta_0.03.RData")
eta_0.03_Ui=Gene.Risk.Status
eta_0.03_all_pi=all.pi
eta_0.03_mirage_pvalue=MIRAGE.pvalue
eta_0.03_mirage_BF=MIRAGE.BF
eta_0.03_fisher_pvalue=Fisher.pvalue
eta_0.03_skato_pvalue=SKATO.pvalue

load("../output/Varyeta_MixedGene_OneRiskVarGroup/eta_0.07.RData")
eta_0.07_Ui=Gene.Risk.Status
eta_0.07_all_pi=all.pi
eta_0.07_mirage_pvalue=MIRAGE.pvalue
eta_0.07_mirage_BF=MIRAGE.BF
eta_0.07_fisher_pvalue=Fisher.pvalue
eta_0.07_skato_pvalue=SKATO.pvalue

load("../output/Varyeta_MixedGene_OneRiskVarGroup/eta_0.1.RData")
eta_0.1_Ui=Gene.Risk.Status
eta_0.1_all_pi=all.pi
eta_0.1_mirage_pvalue=MIRAGE.pvalue
eta_0.1_mirage_BF=MIRAGE.BF
eta_0.1_fisher_pvalue=Fisher.pvalue
eta_0.1_skato_pvalue=SKATO.pvalue

load("../output/Varyeta_MixedGene_OneRiskVarGroup/eta_0.2.RData")
eta_0.2_Ui=Gene.Risk.Status
eta_0.2_all_pi=all.pi
eta_0.2_mirage_pvalue=MIRAGE.pvalue
eta_0.2_mirage_BF=MIRAGE.BF
eta_0.2_fisher_pvalue=Fisher.pvalue
eta_0.2_skato_pvalue=SKATO.pvalue

############### calclate true positive, false positive across 100 runs 
num_run=length(eta_0.1_mirage_pvalue)
#tp=matrix(nrow=num_run, ncol=3); fp=matrix(nrow=num_run, ncol=3)
#for ( i in 1:num_run)
#{
#  risk_gene_index=which(eta_0.1_Ui[[i]]==1); nonrisk_gene_index=which(eta_0.1_Ui[[i]]==0)
  
#  tp[i,1]=sum(eta_0.1_mirage_pvalue[[i]][risk_gene_index]<0.05)/length(risk_gene_index)
#  fp[i,1]=sum(eta_0.1_mirage_pvalue[[i]][nonrisk_gene_index]<0.05)/length(nonrisk_gene_index)
#  tp[i,2]=sum(eta_0.1_fisher_pvalue[[i]][risk_gene_index]<0.05)/length(risk_gene_index)
#  fp[i,2]=sum(eta_0.1_fisher_pvalue[[i]][nonrisk_gene_index]<0.05)/length(nonrisk_gene_index)
#  tp[i,3]=sum(eta_0.1_skato_pvalue[[i]][risk_gene_index]<0.05)/length(risk_gene_index)
#  fp[i,3]=sum(eta_0.1_skato_pvalue[[i]][nonrisk_gene_index]<0.05)/length(nonrisk_gene_index)
#}
##############

# for a single run, draw ROC curve 
i=1
Ui=eta_0.03_Ui[[i]]
mirage_pvalue=eta_0.03_mirage_pvalue[[i]]
mirage_BF=eta_0.03_mirage_BF[[i]]
fisher_pvalue=eta_0.03_fisher_pvalue[[i]]
skato_pvalue=eta_0.03_skato_pvalue[[i]]
method=rep(c("MIRAGE-LRT", "Burden", "SKATO", "MIRAGE-BF"), each=num_run)
#roc_single_run=data.frame(D=Ui, m=c(-log(mirage_pvalue, base=10),-log(fisher_pvalue, base=10), -log(skato_pvalue, base=10)), method=method)
roc_single_run=data.frame(D=Ui, m=c(mirage_pvalue,fisher_pvalue,skato_pvalue, -mirage_BF), method=method)
p1.basic=ggplot(roc_single_run, aes(d = D, m = m, color=method), size=2) + 
  geom_roc(increasing=F, n.cuts=0)+
  style_roc(theme = theme_grey)
p1=p1.basic+
  annotate("text", x =rep(0.7, 4), y = c(0.02,0.1, 0.2, 0.3), 
           label = paste(c("Burden:AUC=", "MIRAGE-BF:AUC=", "MIRAGE-LRT:AUC=", "SKATO:AUC="), round(calc_auc(p1.basic)$AUC, 2)), size=2)+
  ggtitle(expression(paste(eta, "=0.03")))+
theme(plot.title = element_text(hjust = 0.5, size=10))+  #center the title 
 theme(axis.text.x= element_text(size=4))+  # custmorize the axis tick size 
theme(axis.text.y= element_text(size=4))+
  theme(axis.text = element_text(size = 1))
#+ggtitle("Plot of length \n by dose")
  #+scale_x_continuous(breaks = seq(0, 1, by = .1))
  #+scale_y_continuous(breaks = seq(0, 1, by = .1))


Ui=eta_0.07_Ui[[2]]
mirage_pvalue=eta_0.07_mirage_pvalue[[2]]
mirage_BF=eta_0.07_mirage_BF[[2]]
fisher_pvalue=eta_0.07_fisher_pvalue[[2]]
skato_pvalue=eta_0.07_skato_pvalue[[2]]
method=rep(c("MIRAGE-LRT", "Burden", "SKATO", "MIRAGE-BF"), each=num_run)
#roc_single_run=data.frame(D=Ui, m=c(-log(mirage_pvalue, base=10),-log(fisher_pvalue, base=10), -log(skato_pvalue, base=10)), method=method)
roc_single_run=data.frame(D=Ui, m=c(mirage_pvalue,fisher_pvalue,skato_pvalue, -mirage_BF), method=method)
p2.basic=ggplot(roc_single_run, aes(d = D, m = m, color=method)) + 
  geom_roc(increasing=F, n.cuts=0)+
  style_roc(theme = theme_grey)
p2=p2.basic+
  annotate("text", x =rep(0.7, 4), y = c(0.02,0.1, 0.2, 0.3), 
           label = paste(c("Burden:AUC=", "MIRAGE-BF:AUC=", "MIRAGE-LRT:AUC=", "SKATO:AUC="), round(calc_auc(p2.basic)$AUC, 2)),size=2)+
  ggtitle(expression(paste(eta, "=0.07")))+
theme(plot.title = element_text(hjust = 0.5, size=10))+  #center the title 
  theme(axis.text.x= element_text(size=4))+  # custmorize the axis tick size 
theme(axis.text.y= element_text(size=4))

Ui=eta_0.1_Ui[[i]]
mirage_pvalue=eta_0.1_mirage_pvalue[[i]]
mirage_BF=eta_0.1_mirage_BF[[i]]
fisher_pvalue=eta_0.1_fisher_pvalue[[i]]
skato_pvalue=eta_0.1_skato_pvalue[[i]]
method=rep(c("MIRAGE-LRT", "Burden", "SKATO", "MIRAGE-BF"), each=num_run)
#roc_single_run=data.frame(D=Ui, m=c(-log(mirage_pvalue, base=10),-log(fisher_pvalue, base=10), -log(skato_pvalue, base=10)), method=method)
roc_single_run=data.frame(D=Ui, m=c(mirage_pvalue,fisher_pvalue,skato_pvalue, -mirage_BF), method=method)
p3.basic=ggplot(roc_single_run, aes(d = D, m = m, color=method)) + 
  geom_roc(increasing=F, n.cuts=0)+
  style_roc(theme = theme_grey)
p3=p3.basic+
  annotate("text", x =rep(0.7, 4), y = c(0.02,0.1, 0.2, 0.3), 
           label = paste(c("Burden:AUC=", "MIRAGE-BF:AUC=", "MIRAGE-LRT:AUC=", "SKATO:AUC="), round(calc_auc(p3.basic)$AUC, 2)), size=2)+
  ggtitle(expression(paste(eta, "=0.1")))+
theme(plot.title = element_text(hjust = 0.5, size=10))+  #center the title
  theme(axis.text.x= element_text(size=4))+  # custmorize the axis tick size 
theme(axis.text.y= element_text(size=4))

Ui=eta_0.2_Ui[[i]]
mirage_pvalue=eta_0.2_mirage_pvalue[[i]]
mirage_BF=eta_0.2_mirage_BF[[i]]
fisher_pvalue=eta_0.2_fisher_pvalue[[i]]
skato_pvalue=eta_0.2_skato_pvalue[[i]]
method=rep(c("MIRAGE-LRT", "Burden", "SKATO", "MIRAGE-BF"), each=num_run)
#roc_single_run=data.frame(D=Ui, m=c(-log(mirage_pvalue, base=10),-log(fisher_pvalue, base=10), -log(skato_pvalue, base=10)), method=method)
roc_single_run=data.frame(D=Ui, m=c(mirage_pvalue,fisher_pvalue,skato_pvalue, -mirage_BF), method=method)
p4.basic=ggplot(roc_single_run, aes(d = D, m = m, color=method)) + 
  geom_roc(increasing=F, n.cuts=0)+
  style_roc(theme = theme_grey)
p4=p4.basic+
  annotate("text", x =rep(0.7, 4), y = c(0.02,0.1, 0.2, 0.3), 
           label = paste(c("Burden:AUC=", "MIRAGE-BF:AUC=", "MIRAGE-LRT:AUC=", "SKATO:AUC="), round(calc_auc(p4.basic)$AUC, 2)), size=2)+
  ggtitle(expression(paste(eta, "=0.2")))+
theme(plot.title = element_text(hjust = 0.5, size=10))+  #center the title 
  theme(axis.text.x= element_text(size=4))+  # custmorize the axis tick size 
theme(axis.text.y= element_text(size=4))

grid.arrange(p1, p2, p3, p4, top=grid.text("ROC curves"), bottom=grid.text(expression(paste(alpha, "=0.1,", alpha[0], "=0.1,", beta, "=2000,", beta[0], "=1000,", delta, "=0.5,", bar(gamma), "=5"))), nrow=2)
```




**case2: one risk gene has multiple risk variant categories with group specific $\bar{\gamma}$**




Parameter settings: N1=N0=3000 $\alpha=\alpha_0=0.1$, $\beta=2000, \beta_0=1000$, $\delta=0.5$. 100 genes, each having 1000 variants in three different groups, the first group has 30% variants, the second has 40% and the rest 30% are in the third group. In each variant group of every gene, the proportion  of risk variants  $\eta$ is varying at 0.01, 0.05, 0.1 and every risk category has its own    $\bar{\gamma}=5, 3,1$ respectively. The basic idea is that the rarer the varinat is, the more effect size it tends to have. 

```{r, echo=F, warning=F}
load("../output/Var_specific_bargamma_MixedGene_MixtureVariant/roc.RData")
i=2
Ui=Gene.Risk.Status[[i]]
mirage_pvalue=MIRAGE.pvalue[[i]]
mirage_BF=MIRAGE.BF[[i]]
fisher_pvalue=Fisher.pvalue[[i]]
skato_pvalue=SKATO.pvalue[[i]]

num_run=length(mirage_pvalue)


method=rep(c("MIRAGE-LRT", "Burden", "SKATO", "MIRAGE-BF"), each=num_run)
#roc_single_run=data.frame(D=Ui, m=c(-log(mirage_pvalue, base=10),-log(fisher_pvalue, base=10), -log(skato_pvalue, base=10)), method=method)
roc_single_run=data.frame(D=Ui, m=c(mirage_pvalue,fisher_pvalue,skato_pvalue, -mirage_BF), method=method)
p1.basic=ggplot(roc_single_run, aes(d = D, m = m, color=method), size=2) + 
  geom_roc(increasing=F, n.cuts=0)+
  style_roc(theme = theme_grey)
p1=p1.basic+
  annotate("text", x =rep(0.85, 4), y = c(0.02,0.08, 0.14, 0.2), 
           label = paste(c("Burden:AUC=", "MIRAGE-BF:AUC=", "MIRAGE-LRT:AUC=", "SKATO:AUC="), round(calc_auc(p1.basic)$AUC, 2)), size=3)+
  ggtitle("ROC")+
theme(plot.title = element_text(hjust = 0.5, size=10))+  #center the title 
 theme(axis.text.x= element_text(size=6))+  # custmorize the axis tick size 
theme(axis.text.y= element_text(size=6))+
  theme(axis.text = element_text(size = 1))
p1

```


Parameter settings: N1=N0=3000 $\alpha=\alpha_0=0.1$, $\beta=2000, \beta_0=1000$, $\delta=0.1, 0.2, 0.3, 0.4$. 1000 genes, each having 100 variants in three different groups, the first group has 60% variants, the second has 30% and the rest 10% are in the third group. In each variant group of every gene, the proportion  of risk variants  $\eta$ is varying at 0.05, 0.2, 0.5 and every risk category has its own    $\bar{\gamma}$ respectively. The basic idea is that the rarer the varinat is, the more effect size it tends to have. 


```{r, echo=F, eval=F}
rm("Ui", "mirage_pvalue", "mirage_BF", "fisher_pvalue", "skato_pvalue")
load("../output/Var_specific_bargamma_MixedGene_MixtureVariant/delta0.1.RData")
i=1
Ui=Gene.Risk.Status[[i]]
mirage_pvalue=MIRAGE.pvalue[[i]]
mirage_BF=MIRAGE.BF[[i]]
fisher_pvalue=Fisher.pvalue[[i]]
skato_pvalue=SKATO.pvalue[[i]]

num_run=length(mirage_pvalue)


method=rep(c("MIRAGE-LRT", "Burden", "SKATO", "MIRAGE-BF"), each=num_run)
#roc_single_run=data.frame(D=Ui, m=c(-log(mirage_pvalue, base=10),-log(fisher_pvalue, base=10), -log(skato_pvalue, base=10)), method=method)
roc_single_run=data.frame(D=Ui, m=c(mirage_pvalue,fisher_pvalue,skato_pvalue, -mirage_BF), method=method)
p1.basic=ggplot(roc_single_run, aes(d = D, m = m, color=method), size=2) + 
  geom_roc(increasing=F, n.cuts=0)+
  style_roc(theme = theme_grey)
p1=p1.basic+
  annotate("text", x =rep(0.8, 4), y = c(0.02,0.08, 0.14, 0.2), 
           label = paste(c("Burden:AUC=", "MIRAGE-BF:AUC=", "MIRAGE-LRT:AUC=", "SKATO:AUC="), round(calc_auc(p1.basic)$AUC, 2)), size=1.5)+
  ggtitle(expression(paste(delta, "=0.1")))+
theme(plot.title = element_text(hjust = 0.5, size=10))+  #center the title 
 theme(axis.text.x= element_text(size=6))+  # custmorize the axis tick size 
theme(axis.text.y= element_text(size=6))+
  theme(axis.text = element_text(size = 1))


rm("Ui", "mirage_pvalue", "mirage_BF", "fisher_pvalue", "skato_pvalue")
load("../output/Var_specific_bargamma_MixedGene_MixtureVariant/delta0.2.RData")
i=1
Ui=Gene.Risk.Status[[i]]
mirage_pvalue=MIRAGE.pvalue[[i]]
mirage_BF=MIRAGE.BF[[i]]
fisher_pvalue=Fisher.pvalue[[i]]
skato_pvalue=SKATO.pvalue[[i]]

num_run=length(mirage_pvalue)


#roc_single_run=data.frame(D=Ui, m=c(-log(mirage_pvalue, base=10),-log(fisher_pvalue, base=10), -log(skato_pvalue, base=10)), method=method)
roc_single_run=data.frame(D=Ui, m=c(mirage_pvalue,fisher_pvalue,skato_pvalue, -mirage_BF), method=method)
p2.basic=ggplot(roc_single_run, aes(d = D, m = m, color=method), size=2) + 
  geom_roc(increasing=F, n.cuts=0)+
  style_roc(theme = theme_grey)
p2=p2.basic+
  annotate("text", x =rep(0.8, 4), y = c(0.02,0.08, 0.14, 0.2), 
           label = paste(c("Burden:AUC=", "MIRAGE-BF:AUC=", "MIRAGE-LRT:AUC=", "SKATO:AUC="), round(calc_auc(p2.basic)$AUC, 2)), size=1.5)+
  ggtitle(expression(paste(delta, "=0.2")))+
theme(plot.title = element_text(hjust = 0.5, size=10))+  #center the title 
 theme(axis.text.x= element_text(size=6))+  # custmorize the axis tick size 
theme(axis.text.y= element_text(size=6))+
  theme(axis.text = element_text(size = 1))

rm("Ui", "mirage_pvalue", "mirage_BF", "fisher_pvalue", "skato_pvalue")
load("../output/Var_specific_bargamma_MixedGene_MixtureVariant/delta0.3.RData")
i=1
Ui=Gene.Risk.Status[[i]]
mirage_pvalue=MIRAGE.pvalue[[i]]
mirage_BF=MIRAGE.BF[[i]]
fisher_pvalue=Fisher.pvalue[[i]]
skato_pvalue=SKATO.pvalue[[i]]

num_run=length(mirage_pvalue)

#roc_single_run=data.frame(D=Ui, m=c(-log(mirage_pvalue, base=10),-log(fisher_pvalue, base=10), -log(skato_pvalue, base=10)), method=method)
roc_single_run=data.frame(D=Ui, m=c(mirage_pvalue,fisher_pvalue,skato_pvalue, -mirage_BF), method=method)
p3.basic=ggplot(roc_single_run, aes(d = D, m = m, color=method), size=2) + 
  geom_roc(increasing=F, n.cuts=0)+
  style_roc(theme = theme_grey)
p3=p3.basic+
  annotate("text", x =rep(0.8, 4), y = c(0.02,0.08, 0.14, 0.2), 
           label = paste(c("Burden:AUC=", "MIRAGE-BF:AUC=", "MIRAGE-LRT:AUC=", "SKATO:AUC="), round(calc_auc(p3.basic)$AUC, 2)), size=1.5)+
  ggtitle(expression(paste(delta, "=0.3")))+
theme(plot.title = element_text(hjust = 0.5, size=10))+  #center the title 
 theme(axis.text.x= element_text(size=6))+  # custmorize the axis tick size 
theme(axis.text.y= element_text(size=6))+
  theme(axis.text = element_text(size = 1))

rm("Ui", "mirage_pvalue", "mirage_BF", "fisher_pvalue", "skato_pvalue")
load("../output/Var_specific_bargamma_MixedGene_MixtureVariant/delta0.4.RData")
i=1
Ui=Gene.Risk.Status[[i]]
mirage_pvalue=MIRAGE.pvalue[[i]]
mirage_BF=MIRAGE.BF[[i]]
fisher_pvalue=Fisher.pvalue[[i]]
skato_pvalue=SKATO.pvalue[[i]]

num_run=length(mirage_pvalue)
#roc_single_run=data.frame(D=Ui, m=c(-log(mirage_pvalue, base=10),-log(fisher_pvalue, base=10), -log(skato_pvalue, base=10)), method=method)
roc_single_run=data.frame(D=Ui, m=c(mirage_pvalue,fisher_pvalue,skato_pvalue, -mirage_BF), method=method)
p4.basic=ggplot(roc_single_run, aes(d = D, m = m, color=method), size=2) + 
  geom_roc(increasing=F, n.cuts=0)+
  style_roc(theme = theme_grey)
p4=p4.basic+
  annotate("text", x =rep(0.8, 4), y = c(0.02,0.08, 0.14, 0.2), 
           label = paste(c("Burden:AUC=", "MIRAGE-BF:AUC=", "MIRAGE-LRT:AUC=", "SKATO:AUC="), round(calc_auc(p4.basic)$AUC, 2)), size=1.5)+
  ggtitle(expression(paste(delta, "=0.4")))+
theme(plot.title = element_text(hjust = 0.5, size=10))+  #center the title 
 theme(axis.text.x= element_text(size=6))+  # custmorize the axis tick size 
theme(axis.text.y= element_text(size=6))+
  theme(axis.text = element_text(size = 1))

grid.arrange(p1, p2, p3, p4, top=grid.text("ROC curves"), bottom=grid.text(expression(paste(alpha, "=0.1,", alpha[0], "=0.1,", beta, "=2000,", beta[0], "=1000"))), nrow=2)
```


**burden test: for every gene, use all variants in cases and control**

$\bar{\gamma}=1, 3,5$



```{r, echo=F}
rm("Ui", "mirage_pvalue", "mirage_BF", "fisher_pvalue", "skato_pvalue")
load("../output/Var_specific_bargamma_MixedGene_MixtureVariant/5methods_delta0.1.RData")
i=1
Ui=Gene.Risk.Status[[i]]
mirage_pvalue=MIRAGE.pvalue[[i]]
mirage_BF=MIRAGE.BF[[i]]
fisher_pvalue=Fisher.pvalue[[i]]
skato_pvalue=SKATO.pvalue[[i]]
cmc_pvalue=CMC.pvalue[[i]]
asum_pvalue=ASUM.pvalue[[i]]

num_run=length(mirage_pvalue)


method=rep(c("MIRAGE-LRT", "Burden", "SKATO", "MIRAGE-BF", "CMC", "ASUM"), each=num_run)

roc_single_run=data.frame(D=Ui, m=c(mirage_pvalue,fisher_pvalue,skato_pvalue, -mirage_BF, cmc_pvalue, asum_pvalue), method=method)
p.basic=ggplot(roc_single_run, aes(d = D, m = m, color=method), size=2) + 
  geom_roc(increasing=F, n.cuts=0)+
  style_roc(theme = theme_grey)
p=p.basic+
  annotate("text", x =rep(0.85, 6), y = c(0.02,0.08, 0.14, 0.2, 0.25, 0.3), 
           label = paste(c("ASUM:AUC", "Burden:AUC=", "CMC:AUC", "MIRAGE-BF:AUC=", "MIRAGE-LRT:AUC=", "SKATO:AUC="), round(calc_auc(p.basic)$AUC, 2)), size=3)+
  ggtitle(expression(paste(delta, "=0.1")))+
theme(plot.title = element_text(hjust = 0.5, size=10))+  #center the title 
 theme(axis.text.x= element_text(size=6))+  # custmorize the axis tick size 
theme(axis.text.y= element_text(size=6))+
  theme(axis.text = element_text(size = 1))
p
```


```{r, echo=F}
rm("Ui", "mirage_pvalue", "mirage_BF", "fisher_pvalue", "skato_pvalue")
load("../output/Var_specific_bargamma_MixedGene_MixtureVariant/5methods_delta0.05.RData")
i=1
Ui=Gene.Risk.Status[[i]]
mirage_pvalue=MIRAGE.pvalue[[i]]
mirage_BF=MIRAGE.BF[[i]]
fisher_pvalue=Fisher.pvalue[[i]]
skato_pvalue=SKATO.pvalue[[i]]
cmc_pvalue=CMC.pvalue[[i]]
asum_pvalue=ASUM.pvalue[[i]]

num_run=length(mirage_pvalue)


method=rep(c("MIRAGE-LRT", "Burden", "SKATO", "MIRAGE-BF", "CMC", "ASUM"), each=num_run)

roc_single_run=data.frame(D=Ui, m=c(mirage_pvalue,fisher_pvalue,skato_pvalue, -mirage_BF, cmc_pvalue, asum_pvalue), method=method)
p.basic=ggplot(roc_single_run, aes(d = D, m = m, color=method), size=2) + 
  geom_roc(increasing=F, n.cuts=0)+
  style_roc(theme = theme_grey)
p=p.basic+
  annotate("text", x =rep(0.85, 6), y = c(0.02,0.08, 0.14, 0.2, 0.25, 0.3), 
           label = paste(c("ASUM:AUC", "Burden:AUC=", "CMC:AUC", "MIRAGE-BF:AUC=", "MIRAGE-LRT:AUC=", "SKATO:AUC="), round(calc_auc(p.basic)$AUC, 2)), size=3)+
  ggtitle(expression(paste(delta, "=0.05")))+
theme(plot.title = element_text(hjust = 0.5, size=10))+  #center the title 
 theme(axis.text.x= element_text(size=6))+  # custmorize the axis tick size 
theme(axis.text.y= element_text(size=6))+
  theme(axis.text = element_text(size = 1))
p
```



**burden-adj: for every gene, compute p values for 3 variant categories, adjust p values by bonferroni correction  and take the minimum**

$\bar{\gamma}=3,3,5$. burden-comb: use Fisher method to comine p values from 3 independent tests. 


```{r,echo=F}
rm("Ui", "mirage_pvalue", "mirage_BF", "fisher_pvalue", "skato_pvalue")
load("../output/Var_specific_bargamma_MixedGene_MixtureVariant/6methods_delta0.1_gammamean335.RData")
i=2
Ui=Gene.Risk.Status[[i]]
mirage_pvalue=MIRAGE.pvalue[[i]]
mirage_BF=MIRAGE.BF[[i]]
fisher_pvalue=Fisher.pvalue[[i]]
skato_pvalue=SKATO.pvalue[[i]]
cmc_pvalue=CMC.pvalue[[i]]
asum_pvalue=ASUM.pvalue[[i]]
fisher.separate.pvalue=Fisher.separate.pvalue[[i]]
fisher.adj.pvalue=numeric()
fisher.combine.pvalue=numeric()
for (i in 1:nrow(fisher.separate.pvalue))
{
  fisher.adj.pvalue[i]=min(p.adjust(fisher.separate.pvalue[i,], method = "bonferroni", n = length(fisher.separate.pvalue[i,])))
  # fisher.adj.pvalue[i]=min(fisher.separate.pvalue[i,])
   fisher.combine.pvalue[i]=pchisq(-sum(log(fisher.separate.pvalue[i,])), df=6, ncp = 0, lower.tail = TRUE)
}
  
num_run=length(mirage_pvalue)


method=rep(c("MIRAGE-LRT", "Burden", "SKATO", "MIRAGE-BF", "CMC", "ASUM", "Burden_adj", "Burden_comb"), each=num_run)

roc_single_run=data.frame(D=Ui, m=c(mirage_pvalue,fisher_pvalue,skato_pvalue, -mirage_BF, cmc_pvalue, asum_pvalue, fisher.adj.pvalue, -fisher.combine.pvalue), method=method)
p.basic=ggplot(roc_single_run, aes(d = D, m = m, color=method), size=2) + 
  geom_roc(increasing=F, n.cuts=0)+
  style_roc(theme = theme_grey)
p_delta0.1=p.basic+
  annotate("text", x =rep(0.7, 8), y = c(0.02,0.08, 0.14, 0.2, 0.25, 0.3, 0.35, 0.4), 
           label = paste(c("ASUM:AUC", "Burden_adj:AUC", "Burden:AUC=", "Burden_comb:AUC", "CMC:AUC", "MIRAGE-BF:AUC=", "MIRAGE-LRT:AUC=", "SKATO:AUC="), round(calc_auc(p.basic)$AUC, 2)), size=2)+
  ggtitle(expression(paste(delta, "=0.1")))+
theme(plot.title = element_text(hjust = 0.5, size=10))+  #center the title 
 theme(axis.text.x= element_text(size=6))+  # custmorize the axis tick size 
theme(axis.text.y= element_text(size=6))+
  theme(axis.text = element_text(size = 1))
p_delta0.1
```


```{r,echo=F}
rm("Ui", "mirage_pvalue", "mirage_BF", "fisher_pvalue", "skato_pvalue")
load("../output/Var_specific_bargamma_MixedGene_MixtureVariant/6methods_delta0.01_gammamean335.RData")
i=2
Ui=Gene.Risk.Status[[i]]
mirage_pvalue=MIRAGE.pvalue[[i]]
mirage_BF=MIRAGE.BF[[i]]
fisher_pvalue=Fisher.pvalue[[i]]
skato_pvalue=SKATO.pvalue[[i]]
cmc_pvalue=CMC.pvalue[[i]]
asum_pvalue=ASUM.pvalue[[i]]
fisher.separate.pvalue=Fisher.separate.pvalue[[i]]
fisher.adj.pvalue=numeric()
fisher.combine.pvalue=numeric()
for (i in 1:nrow(fisher.separate.pvalue))
{
  fisher.adj.pvalue[i]=min(p.adjust(fisher.separate.pvalue[i,], method = "bonferroni", n = length(fisher.separate.pvalue[i,])))
  fisher.combine.pvalue[i]=pchisq(-sum(log(fisher.separate.pvalue[i,])), df=6, ncp = 0, lower.tail = TRUE)
}  
  # fisher.adj.pvalue[i]=min(fisher.separate.pvalue[i,])

num_run=length(mirage_pvalue)


method=rep(c("MIRAGE-LRT", "Burden", "SKATO", "MIRAGE-BF", "CMC", "ASUM", "Burden_adj", "Burden_comb"), each=num_run)

roc_single_run=data.frame(D=Ui, m=c(mirage_pvalue,fisher_pvalue,skato_pvalue, -mirage_BF, cmc_pvalue, asum_pvalue, fisher.adj.pvalue, -fisher.combine.pvalue), method=method)
p1.basic=ggplot(roc_single_run, aes(d = D, m = m, color=method), size=2) + 
  geom_roc(increasing=F, n.cuts=0)+
  style_roc(theme = theme_grey)
p1_delta0.01=p1.basic+
  annotate("text", x =rep(0.7, 8), y = c(0.02,0.08, 0.14, 0.2, 0.25, 0.3, 0.35, 0.4), 
           label = paste(c("ASUM:AUC", "Burden_adj:AUC", "Burden:AUC=", "Burden_comb:AUC", "CMC:AUC", "MIRAGE-BF:AUC=", "MIRAGE-LRT:AUC=", "SKATO:AUC="), round(calc_auc(p1.basic)$AUC, 2)), size=2)+
  ggtitle(expression(paste(delta, "=0.01")))+
theme(plot.title = element_text(hjust = 0.5, size=10))+  #center the title 
 theme(axis.text.x= element_text(size=6))+  # custmorize the axis tick size 
theme(axis.text.y= element_text(size=6))+
  theme(axis.text = element_text(size = 1))

################################ delta=0.05
rm("Ui", "mirage_pvalue", "mirage_BF", "fisher_pvalue", "skato_pvalue")
load("../output/Var_specific_bargamma_MixedGene_MixtureVariant/6methods_delta0.05_gammamean335_2.RData")
i=1
Ui=Gene.Risk.Status[[i]]
mirage_pvalue=MIRAGE.pvalue[[i]]
mirage_BF=MIRAGE.BF[[i]]
fisher_pvalue=Fisher.pvalue[[i]]
skato_pvalue=SKATO.pvalue[[i]]
cmc_pvalue=CMC.pvalue[[i]]
asum_pvalue=ASUM.pvalue[[i]]
fisher.separate.pvalue=Fisher.separate.pvalue[[i]]
fisher.adj.pvalue=numeric()
fisher.combine.pvalue=numeric()
for (i in 1:nrow(fisher.separate.pvalue))
{
  fisher.adj.pvalue[i]=min(p.adjust(fisher.separate.pvalue[i,], method = "bonferroni", n = length(fisher.separate.pvalue[i,])))
  fisher.combine.pvalue[i]=pchisq(-sum(log(fisher.separate.pvalue[i,])), df=6, ncp = 0, lower.tail = TRUE)
}  
  # fisher.adj.pvalue[i]=min(fisher.separate.pvalue[i,])

num_run=length(mirage_pvalue)


method=rep(c("MIRAGE-LRT", "Burden", "SKATO", "MIRAGE-BF", "CMC", "ASUM", "Burden_adj", "Burden_comb"), each=num_run)

roc_single_run=data.frame(D=Ui, m=c(mirage_pvalue,fisher_pvalue,skato_pvalue, -mirage_BF, cmc_pvalue, asum_pvalue, fisher.adj.pvalue, -fisher.combine.pvalue), method=method)
p2.basic=ggplot(roc_single_run, aes(d = D, m = m, color=method), size=2) + 
  geom_roc(increasing=F, n.cuts=0)+
  style_roc(theme = theme_grey)
#pdf("../../Figure/power_comparison_different_methods.pdf")
p2_delta0.05=p2.basic+
  annotate("text", x =rep(0.7, 8), y = c(0.02,0.08, 0.14, 0.2, 0.25, 0.3, 0.34, 0.4), 
           label = paste(c("ASUM:AUC", "Burden_adj:AUC",  "Burden:AUC=", "Burden_comb:AUC","CMC:AUC", "MIRAGE-BF:AUC=", "MIRAGE-LRT:AUC=", "SKATO:AUC="), round(calc_auc(p2.basic)$AUC, 2)), size=2)+
  ggtitle(expression(paste(delta, "=0.05")))+
theme(plot.title = element_text(hjust = 0.5, size=10))+  #center the title 
 theme(axis.text.x= element_text(size=6))+  # custmorize the axis tick size 
theme(axis.text.y= element_text(size=6))+
  theme(axis.text = element_text(size = 1))
p2_delta0.05
#grid.arrange(p1, p2, top=grid.text("ROC curves"), bottom=grid.text(expression(paste(alpha, "=0.1,", alpha[0], "=0.1,", beta, "=2000,", beta[0], "=1000"))), nrow=1)
#dev.off()

#############################
rm("Ui", "mirage_pvalue", "mirage_BF", "fisher_pvalue", "skato_pvalue")
load("../output/Var_specific_bargamma_MixedGene_MixtureVariant/6methods_delta0.2_gammamean335.RData")
i=1
Ui=Gene.Risk.Status[[i]]
mirage_pvalue=MIRAGE.pvalue[[i]]
mirage_BF=MIRAGE.BF[[i]]
fisher_pvalue=Fisher.pvalue[[i]]
skato_pvalue=SKATO.pvalue[[i]]
cmc_pvalue=CMC.pvalue[[i]]
asum_pvalue=ASUM.pvalue[[i]]
fisher.separate.pvalue=Fisher.separate.pvalue[[i]]
fisher.adj.pvalue=numeric()
fisher.combine.pvalue=numeric()
for (i in 1:nrow(fisher.separate.pvalue))
{
  fisher.adj.pvalue[i]=min(p.adjust(fisher.separate.pvalue[i,], method = "bonferroni", n = length(fisher.separate.pvalue[i,])))
  fisher.combine.pvalue[i]=pchisq(-sum(log(fisher.separate.pvalue[i,])), df=6, ncp = 0, lower.tail = TRUE)
}  
  # fisher.adj.pvalue[i]=min(fisher.separate.pvalue[i,])

num_run=length(mirage_pvalue)


method=rep(c("MIRAGE-LRT", "Burden", "SKATO", "MIRAGE-BF", "CMC", "ASUM", "Burden_adj", "Burden_comb"), each=num_run)

roc_single_run=data.frame(D=Ui, m=c(mirage_pvalue,fisher_pvalue,skato_pvalue, -mirage_BF, cmc_pvalue, asum_pvalue, fisher.adj.pvalue, -fisher.combine.pvalue), method=method)
p2.basic=ggplot(roc_single_run, aes(d = D, m = m, color=method), size=2) + 
  geom_roc(increasing=F, n.cuts=0)+
  style_roc(theme = theme_grey)
#pdf("../../Figure/power_comparison_different_methods.pdf")
p_delta0.2=p2.basic+
  annotate("text", x =rep(0.7,8), y = c(0.02,0.08, 0.14, 0.2, 0.25, 0.3, 0.35, 0.4), 
           label = paste(c("ASUM:AUC", "Burden_adj:AUC",  "Burden:AUC=", "Burden_comb:AUC","CMC:AUC", "MIRAGE-BF:AUC=", "MIRAGE-LRT:AUC=", "SKATO:AUC="), round(calc_auc(p2.basic)$AUC, 2)), size=2)+
  ggtitle(expression(paste(delta, "=0.2")))+
theme(plot.title = element_text(hjust = 0.5, size=10))+  #center the title 
 theme(axis.text.x= element_text(size=6))+  # custmorize the axis tick size 
theme(axis.text.y= element_text(size=6))+
  theme(axis.text = element_text(size = 1))
p_delta0.2
```

```{r, echo=F}
grid.arrange(p1_delta0.01, p2_delta0.05, p_delta0.1, p_delta0.2, nrow=2) 

#p1_delta0.01
#p2_delta0.05
#p_delta0.1
#p_delta0.2
```

**Parameter estimate**

$\beta_1=0.05,\beta_2=0.2, \beta_3=0.5, \delta=0.1$


```{r, echo=F, warning=F}
load("../output/Var_specific_bargamma_MixedGene_MixtureVariant/delta0.1_gammamean335_paraest.RData")
all.pi=all.pi
method=c(rep("True", 4), rep("Estimate", 4))
mean=c(c(0.05, 0.20, 0.50, 0.1),colMeans(all.pi))
sd=c(rep(0,4),colSds(all.pi))
parameter=c(rep(c("beta1", "beta2", "beta3", "delta"),2))
summary=data.frame(mean=mean, sd=sd, para=parameter, method=method)
ggplot(summary, aes(x=para, y=mean, fill=method)) + 
   geom_bar(stat="identity", 
           position=position_dodge()) +
   geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2,
                 position=position_dodge(.9))+
  ylab("Parameter estimate")+
  theme(legend.title=element_blank())+
  xlab("")+ylab("")+
  ggtitle("Parameter estimate across 100 simulated replicates")+
  theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
  #ylab(expression(paste(hat(eta))))+ 
  #guides(fill=guide_legend(title=NULL))+
  #ylim(0.05,0.15)+
  # geom_hline(yintercept=0.1,linetype="dashed", color = "red")
```



### type I error

#### Only variant level, no gene level

To investigate the type one error, we simulated 100 independent data sets, each with $N1=N0=3000$, 100 variants in one group; no risk variants, i.e., $\eta=0$ and other parameters are pretty the same as before 
$\alpha_0=0.1, \beta_0=1000,\alpha= 0.1, \beta=2000,\bar{\gamma}=4,\sigma= 1$.




```{r, echo=F}
load("../output/TypeOneError/Simulation_OneGene_OneNonrisk_VarGroup.RData")
summary=as_tibble(summary)
mirage_fisher=data.frame(pvalue=c(summary$MIRAGE.pvalue,summary$Fisher.pvalue), method=c(rep("MIRAGE", nrow(summary)), rep("Burden", nrow(summary))))
g1=ggplot(summary, aes(x=eta_est))+
  geom_density()+
  scale_fill_manual(values=c("#00BFC4"))+
  xlab(expression(paste(hat(eta))))
#g1

g2=ggplot(mirage_fisher, aes(x=pvalue, fill=method))+
  geom_histogram(position="dodge2")+
  xlab("p value")
g2

#plot_grid(g1, g2)
#ggplot(mirage_fisher, aes(x=pvalue, colour=method))+
#geom_freqpoly()
```

Burden test: use fisher exact test
MIRAGE: first estimate parameter $\eta$, then do likelihood ratio test 




To investigate the type one error, we simulated one independent data set,  with $N1=N0=3000$, 1000 genes are all non-risk genes. Every gene has 100 variants in three non-risk variant  groups; no risk variant groups i.e., $\eta=0$ and other parameters are pretty the same as before 
$\alpha_0=0.1, \beta_0=1000,\alpha= 0.1, \beta=2000,\bar{\gamma}=3,4,5,\sigma= 1$.



```{r, echo=F}
load("../output/TypeOneError/All_Nonrisk_Gene_Gammamean3.RData")
pvalue_gammamean3=tibble(mirage.pvalue=mirage.pvalue, fisher.pvalue=fisher.pvalue, skato.pvalue=skat.pvalue)
pvalue_gammamean3_gather=pvalue_gammamean3 %>% gather(method, pvalue, mirage.pvalue:skato.pvalue)
g1=ggplot(pvalue_gammamean3_gather, aes(x=pvalue, y=(..count..)/sum(..count..)))+
#  geom_histogram()+
  geom_histogram(position="dodge2")+
  facet_grid(~method)+
  xlab("p value")+
  ylab("Proportion")+
  ggtitle(expression(paste(bar(gamma), "=3")))

#eta_est_gammamean3=as_tibble(beta.k)

load("../output/TypeOneError/All_Nonrisk_Gene_Gammamean4.RData")
pvalue_gammamean3=tibble(mirage.pvalue=mirage.pvalue, fisher.pvalue=fisher.pvalue, skato.pvalue=skat.pvalue)
pvalue_gammamean3_gather=pvalue_gammamean3 %>% gather(method, pvalue, mirage.pvalue:skato.pvalue)
g2=ggplot(pvalue_gammamean3_gather, aes(x=pvalue, y=(..count..)/sum(..count..)))+
#  geom_histogram()+
  geom_histogram(position="dodge2")+
  facet_grid(~method)+
  xlab("p value")+
  ylab("Proportion")+
  ggtitle(expression(paste(bar(gamma), "=4")))



load("../output/TypeOneError/All_Nonrisk_Gene_Gammamean5.RData")
pvalue_gammamean3=tibble(mirage.pvalue=mirage.pvalue, fisher.pvalue=fisher.pvalue, skato.pvalue=skat.pvalue)
pvalue_gammamean3_gather=pvalue_gammamean3 %>% gather(method, pvalue, mirage.pvalue:skato.pvalue)
g3=ggplot(pvalue_gammamean3_gather, aes(x=pvalue, y=(..count..)/sum(..count..)))+
#  geom_histogram()+
  geom_histogram(position="dodge2")+
  facet_grid(~method)+
  xlab("p value")+
  ylab("Proportion")+
  ggtitle(expression(paste(bar(gamma), "=5")))


#grid.arrange(g1, g2, g3, nrow=3) 

g1
g2
g3
#plot_grid(g1, g2)
#ggplot(mirage_fisher, aes(x=pvalue, colour=method))+
#geom_freqpoly()
```



### Bayesian FDR control 


Simulated one data set, $N1=N0=3000$, 10\% of 1000 genes are risk genes. Every gene has 100 variants in three variant  groups with $\eta_1=0.05, \eta_2=0.2, \eta_3=0.5$ and the proportion of variants are 30\%, 40\% and 30\%. Other parameters are pretty the same as before 
$\alpha_0=0.1, \beta_0=1000,\alpha= 0.1, \beta=2000,\bar{\gamma}=5,\sigma= 1$.


```{r, echo=F}
################## true gamma.bar=5, use true value ###############
rm("beta.k", "BF.gene", "mirage.pvalue", "skat.pvalue", "fisher.pvalue")
load("../output/BayesianFDR/Mixed_Gene_Gammamean5.delta0.1.RData")
BF.gene=BF.gene[complete.cases(BF.gene), ]
Bayes_factor=tibble(BF=BF.gene[nrow(BF.gene),])


prior_cons=0.1
cons_post=Bayes_factor %>% mutate(post_prob=prior_cons*BF/(1-prior_cons+prior_cons*BF))
cons_post=as_tibble(cbind(cons_post, RiskStatus=Ui))
(No.Disc=cons_post %>% filter(post_prob>0.5) %>% tally())

(TP=cons_post %>% filter(post_prob>0.5) %>% filter(RiskStatus==1) %>% tally())

FDR=1-TP/No.Disc
FDR


tau=seq(0, 0.999, by=0.001)
num_pred=NULL
false_disc=NULL
FDR=NULL
for (i in 1:length(tau))
{
num_pred[i]=sum(ifelse(cons_post$post_prob>tau[i], 1, 0))
false_disc[i]=sum((1-cons_post$post_prob)*ifelse(cons_post$post_prob>tau[i], 1, 0))
FDR[i]=false_disc[i]/num_pred[i]
}
tau_fdr5=tibble(tau=tau, bar5_fdr=FDR)%>%drop_na()  # drop rows with NA

#g1=ggplot(tau_fdr)+
#  geom_point(aes(x=tau, y=fdr))+
#  xlab(expression(paste(tau)))+ylab("FDR")


##################### true gamma.bar=5, use gamma.bar=3 ##########
rm("beta.k", "BF.gene", "mirage.pvalue", "skat.pvalue", "fisher.pvalue")
load("../output/BayesianFDR/Mixed_Gene_Gammamean5_useGammabar3.delta0.1.RData")
BF.gene=BF.gene[complete.cases(BF.gene), ]
Bayes_factor=tibble(BF=BF.gene[nrow(BF.gene),])


prior_cons=0.1
cons_post=Bayes_factor %>% mutate(post_prob=prior_cons*BF/(1-prior_cons+prior_cons*BF))
cons_post=as_tibble(cbind(cons_post, RiskStatus=Ui))



tau=seq(0, 0.999, by=0.001)
num_pred=NULL
false_disc=NULL
FDR=NULL
for (i in 1:length(tau))
{
num_pred[i]=sum(ifelse(cons_post$post_prob>tau[i], 1, 0))
false_disc[i]=sum((1-cons_post$post_prob)*ifelse(cons_post$post_prob>tau[i], 1, 0))
FDR[i]=false_disc[i]/num_pred[i]
}
tau_fdr3=tibble(tau=tau, bar3_fdr=FDR)%>%drop_na()  # drop rows with NA



(No.Disc=cons_post %>% filter(post_prob>0.495) %>% tally())

(TP=cons_post %>% filter(post_prob>0.495) %>% filter(RiskStatus==1) %>% tally())

FDR=1-TP/No.Disc
FDR
#g2=ggplot(tau_fdr)+
#  geom_point(aes(x=tau, y=fdr))+
#  xlab(expression(paste(tau)))+ylab("FDR")


##################### true gamma.bar=5, use gamma.bar=4 ##########
rm("beta.k", "BF.gene", "mirage.pvalue", "skat.pvalue", "fisher.pvalue")
load("../output/BayesianFDR/Mixed_Gene_Gammamean5_useGammabar4.delta0.1.RData")
BF.gene=BF.gene[complete.cases(BF.gene), ]
Bayes_factor=tibble(BF=BF.gene[nrow(BF.gene),])


prior_cons=0.1
cons_post=Bayes_factor %>% mutate(post_prob=prior_cons*BF/(1-prior_cons+prior_cons*BF))
cons_post=as_tibble(cbind(cons_post, RiskStatus=Ui))


tau=seq(0, 0.999, by=0.001)
num_pred=NULL
false_disc=NULL
FDR=NULL
for (i in 1:length(tau))
{
num_pred[i]=sum(ifelse(cons_post$post_prob>tau[i], 1, 0))
false_disc[i]=sum((1-cons_post$post_prob)*ifelse(cons_post$post_prob>tau[i], 1, 0))
FDR[i]=false_disc[i]/num_pred[i]
}
tau_fdr4=tibble(tau=tau, bar4_fdr=FDR)%>%drop_na()  # drop rows with NA

(No.Disc=cons_post %>% filter(post_prob>0.495) %>% tally())

(TP=cons_post %>% filter(post_prob>0.495) %>% filter(RiskStatus==1) %>% tally())

FDR=1-TP/No.Disc
FDR

#g3=ggplot(tau_fdr)+
#  geom_point(aes(x=tau, y=fdr))+
#  xlab(expression(paste(tau)))+ylab("FDR")

#plot_grid(g1, g2, g3, nrow=1)
tau_fdr_combine=full_join(full_join(tau_fdr3, tau_fdr4), tau_fdr5)
tau_fdr_combine_tidy=tau_fdr_combine %>% gather(gamma.bar, fdr, bar3_fdr:bar5_fdr)

ggplot(tau_fdr_combine_tidy)+
  geom_point(aes(x=tau, y=fdr, color=gamma.bar))+
  xlab(expression(paste(tau)))+ylab("FDR")+
  ggtitle(expression(paste("True ", bar(gamma), "=5")))
```




When $FDR<0.1, \tau>0.5$


true $\bar{\gamma}=5$|No.Gene picked | No. true risk gene | FDR 
---------------|---------------|-------------------|-----
  5 | 84 | 72 | 9.76%
  4| 87 | 74 | 14.94%
3 | 71 | 67 | 5.63%  
  



## Logistic priors  
### Case 1: One annotation feature
#### Paramster settings 1 : 

* $\delta=1$
* $N1=N0=5000$
* number of genes $I=1000$, number of variants per gene $m=200$ before filtering. 
* $\alpha=\alpha_0=0.1$, $\beta_0=1000, \beta=2000$. 
* $\beta_{true}=0.5$,  $\bar{\gamma}=10$
* 80\% elements of of Ajk are 1

This is the simplest case in that every variant has one annotation feature if any. 


#### likelihood function: 
If the feature has one dimension, the objective likelihood function would be simple to be optimized using common R packages. The log likelihood as a function of $\beta$ (true $\beta=0.5$)is as 



![loglikelihood](figure/loglikelihood.png). 

This plot tells us the likelihood only has one mode in one dimension case. It looks like $\beta$ is overestimated by R package-BFGS. With the fixed randomly generated data, run BFGS 50 times with random initials. The mean of $\hat{\beta}_{MLE}=0.7631$ and SD=2.344796e-05. 


#### Effect of Sparsity of $A_{jk}$ ($k$ is the number of features, here $k=1$) on MLE of $\beta$

Set $\beta_{true}=0.5$, vary the sparsity of $A_{jk}$, i.e., the ratio of 0's in $A_{jk}$. Define sparsity rate as the ratio of 0's in each feature category.  


Sparsity rate | 90% | 80% |70%  |60% |50% |40%  | 30% |20% |10% | 0|
-------------|-------|--------|-------|-------|-------|-------|------|------|------|------|
$\hat{\beta}_{MLE}$ |0.3802 | 0.4499 |0.5845 |0.5420 |0.5829 |0.64444|0.6817|0.7608|0.7941|0.8896|
Table: MLE at different sparsity rate $\beta_{true}=0.5$

When All entries of $A_{jk}$ are zero, $\tau_j=\frac{1}{2}$, regardless of whatever values of $\beta$ and the likelihood function is a constant of $\beta$. Thus $\widehat{\beta}$ can be anywhere.   


Set $\beta_{true}=0.2$.  


Sparsity rate | 95% | 90% |85%  |80% |75% |70%  | 65% |60% |55% | 50%|
-------------|-------|-------|--------|-------|-------|-------|-------|------|------|------|------|
$\hat{\beta}_{MLE}$|0.3075 | 0.2259 |0.3481 |0.3944 |0.3677 |0.4167|0.3956|0.4331|0.4565|0.4091|
Table: MLE at different sparsity rate with  $\beta_{true}=0.2$. 

####Important Note: 
There are two variables affecting estimate of $\beta$, sparsity of $A_{jk}$ and $\beta_{true}$. 
(1) $\beta$ cannot be set too large, say >10 because it controls the probability of a variant of being causal. Consider an extreme case where all variants are truly causal risk variants. The likelihood of the data is close to the product of Bayes factor of every variant, free of $\beta$ value. Any large enough $\beta$ will give the same likelihood. (2) Sparsity of $A_{jk}$ will certainly influences the estimate of $\beta$. The less sparsity, the more information will be used, the more accurate the estimate will be. (3) AF cannot be too large because for common variants with large odds ratio (large $\bar{\gamma}$), Bayes factor will become overflow of being Inf.      

####Parameter setting 2-increasing sample size
* $\delta=1$
* $\beta_{true}=2$, $\bar{\gamma}=10$
* all entries of $A_{jk}$ are 1
* $\alpha=\alpha_0=0.1$, $\beta=1000, \beta_0=2000$



N1=N0|10,000 | 50,000 | 100,000|
--------|-------|--------|-----------------------------------------
 $\widehat{\beta}_{MLE}$ by Optim | 2.7810 (0.0362) | 2.4413 (0.0161)| 2.3420 
$\widehat{\beta}_{MLE}$ by GLM | 2.0016  (0.0126)|
Table: MLE averaging across 10 replicates with different sample size 


To use GLM, $Z_{ij}$ is treated as response (but in practice, $Z_{ij}$ is unknown) and each column of $A_{jk}$ is a predictor, but without intercept.  

Use function GLM to estimate $\beta$. 


### Case 2: Two Annotation features 
$K=2$. Set $\beta_1=0.05, \beta_2=2$. Other parameters are 

* $\delta=1$
* $\bar{\gamma}=10$
* $\alpha=\alpha_0=0.1$, $\beta=1000, \beta_0=2000$

When there are more than 2 groups, $A_{ij}$ must be designed carefully such that all columns (all annotations) have as little overlap as possible. Otherwise, the method have difficulty in distinguishing between them, leading to poor estimate. In simulations below, these two factures have no overlap. 



N1=N0|10,000 | 50,000 | 80,000|
--------|-------|--------|-----------------------------------------
 $\widehat{\beta_1}_{MLE}$ by Optim | 0.3472 (0.0239) | 0.2287 (0.0252)|0.2371 (0.0193)  
 $\widehat{\beta_2}_{MLE}$ by Optim | 2.7807 (0.0919) | 2.4239 (0.0211)| 2.3636 (0.0243)
$\widehat{\beta_1}_{MLE}$ by GLM | 0.0517  (0.0159)| |
$\widehat{\beta_2}_{MLE}$ by GLM | 1.9952  (0.0177)||
Table: MLE averaging across 10 replicates with different sample size 


### Case 3:  Many annotation features


## Session information

<!-- Insert the session information into the document -->
```{r session-info}
```
